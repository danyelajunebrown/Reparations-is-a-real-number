<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contribute Historical Records - Intelligent Extraction</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95em;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .input-section {
            background: #16213e;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .input-section h2 {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #667eea;
        }

        .url-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .url-input-group input {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #333;
            border-radius: 8px;
            background: #0f3460;
            color: #fff;
            outline: none;
        }

        .url-input-group input:focus {
            border-color: #667eea;
        }

        .btn {
            padding: 15px 25px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #333;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #444;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Classification Display */
        .classification-result {
            background: #0f3460;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .classification-result.visible {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .source-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .source-badge.primary {
            background: #27ae60;
            color: white;
        }

        .source-badge.secondary {
            background: #f39c12;
            color: white;
        }

        .source-badge.tertiary {
            background: #e67e22;
            color: white;
        }

        .source-badge.unknown {
            background: #7f8c8d;
            color: white;
        }

        .classification-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .detail-box {
            background: #1a1a2e;
            padding: 15px;
            border-radius: 8px;
        }

        .detail-box label {
            display: block;
            font-size: 0.85em;
            color: #888;
            margin-bottom: 5px;
        }

        .detail-box .value {
            font-size: 1.1em;
            font-weight: 600;
        }

        .confidence-bar {
            height: 8px;
            background: #333;
            border-radius: 4px;
            margin-top: 8px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            transition: width 0.5s ease;
        }

        /* Extraction Options */
        .extraction-options {
            background: #16213e;
            border-radius: 12px;
            padding: 25px;
            margin-top: 25px;
            display: none;
        }

        .extraction-options.visible {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .extraction-options h3 {
            margin-bottom: 15px;
            color: #667eea;
        }

        .option-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .option-card {
            background: #0f3460;
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option-card:hover {
            border-color: #667eea;
        }

        .option-card.selected {
            border-color: #27ae60;
            background: #0d3a4a;
        }

        .option-card h4 {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .option-card p {
            font-size: 0.9em;
            color: #aaa;
        }

        /* Status Area */
        .status-area {
            background: #16213e;
            border-radius: 12px;
            padding: 25px;
            margin-top: 25px;
            display: none;
        }

        .status-area.visible {
            display: block;
        }

        .status-area h3 {
            margin-bottom: 15px;
            color: #667eea;
        }

        .status-log {
            background: #0f3460;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-entry.success {
            color: #2ecc71;
        }

        .log-entry.error {
            color: #e74c3c;
        }

        .log-entry.info {
            color: #3498db;
        }

        .log-entry .timestamp {
            color: #666;
            margin-right: 10px;
        }

        /* FamilySearch Catalog View */
        .catalog-films {
            margin-top: 20px;
        }

        .film-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .film-item {
            background: #0f3460;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .film-item.completed {
            opacity: 0.6;
        }

        .film-info h4 {
            margin-bottom: 5px;
        }

        .film-info .meta {
            font-size: 0.85em;
            color: #888;
        }

        .film-status {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
        }

        .film-status.pending {
            background: #f39c12;
            color: white;
        }

        .film-status.processing {
            background: #3498db;
            color: white;
        }

        .film-status.completed {
            background: #27ae60;
            color: white;
        }

        /* Results Summary */
        .results-summary {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            border-radius: 12px;
            padding: 25px;
            margin-top: 25px;
            text-align: center;
            display: none;
        }

        .results-summary.visible {
            display: block;
        }

        .results-summary h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Nav link */
        .nav-link {
            display: inline-block;
            margin-top: 15px;
            color: #667eea;
            text-decoration: none;
        }

        .nav-link:hover {
            text-decoration: underline;
        }

        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Intelligent Document Contribution</h1>
        <p>Paste a URL and we'll automatically determine the best extraction method</p>
    </div>

    <div class="container">
        <!-- URL Input Section -->
        <div class="input-section">
            <h2>Step 1: Enter Source URL</h2>
            <div class="url-input-group">
                <input type="url" id="sourceUrl" placeholder="https://msa.maryland.gov/... or https://familysearch.org/..." autocomplete="off">
                <button class="btn btn-primary" id="analyzeBtn" onclick="analyzeUrl()">
                    Analyze Source
                </button>
            </div>
            <p style="color: #888; font-size: 0.9em; margin-top: 10px;">
                Supports: Maryland State Archives, FamilySearch, Civil War DC, Ancestry, and more
            </p>
        </div>

        <!-- Classification Result -->
        <div class="classification-result" id="classificationResult">
            <span class="source-badge" id="sourceBadge">PRIMARY</span>
            <h3 id="sourceName">Maryland State Archives</h3>
            <p id="sourceMessage" style="color: #aaa; margin-bottom: 15px;"></p>

            <div class="classification-details">
                <div class="detail-box">
                    <label>Confidence</label>
                    <div class="value" id="confidenceValue">95%</div>
                    <div class="confidence-bar">
                        <div class="confidence-fill" id="confidenceFill" style="width: 95%"></div>
                    </div>
                </div>
                <div class="detail-box">
                    <label>Extraction Method</label>
                    <div class="value" id="extractionMethod">PDF + OCR</div>
                </div>
                <div class="detail-box">
                    <label>Expected Data</label>
                    <div class="value" id="expectedData">Enslaved Persons, Slaveholders</div>
                </div>
                <div class="detail-box">
                    <label>Auto-Confirm</label>
                    <div class="value" id="autoConfirm">Yes - Primary Source</div>
                </div>
            </div>
        </div>

        <!-- Extraction Options -->
        <div class="extraction-options" id="extractionOptions">
            <h3>Step 2: Choose Extraction Method</h3>
            <div class="option-cards">
                <div class="option-card" onclick="selectMethod('auto')" id="methodAuto">
                    <h4>Auto-Extract</h4>
                    <p>Let the system automatically download and OCR the document (recommended for PDF archives)</p>
                </div>
                <div class="option-card" onclick="selectMethod('screenshots')" id="methodScreenshots">
                    <h4>Screenshot Upload</h4>
                    <p>Upload screenshots if the document can't be downloaded directly</p>
                </div>
                <div class="option-card" onclick="selectMethod('paste')" id="methodPaste">
                    <h4>Copy & Paste Text</h4>
                    <p>Paste transcribed text if you've already extracted it</p>
                </div>
            </div>

            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-primary" id="startExtractionBtn" onclick="startExtraction()" disabled>
                    Start Extraction
                </button>
            </div>
        </div>

        <!-- FamilySearch Catalog Films -->
        <div class="catalog-films" id="catalogFilms" style="display: none;">
            <h3>FamilySearch Catalog - Available Films</h3>
            <p style="color: #888; margin-bottom: 15px;">This catalog contains multiple film collections. Select which to process:</p>
            <div class="film-list" id="filmList"></div>
            <div style="margin-top: 15px; text-align: center;">
                <button class="btn btn-primary" onclick="queueSelectedFilms()">Queue Selected Films</button>
                <button class="btn btn-secondary" onclick="queueAllFilms()">Queue All Films</button>
            </div>
        </div>

        <!-- Status Area -->
        <div class="status-area" id="statusArea">
            <h3>Extraction Progress</h3>
            <div class="status-log" id="statusLog">
                <div class="log-entry info"><span class="timestamp"></span>Waiting to start...</div>
            </div>
        </div>

        <!-- Results Summary -->
        <div class="results-summary" id="resultsSummary">
            <h3>Extraction Complete!</h3>
            <p>Records have been extracted and saved to the database.</p>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="recordsExtracted">0</div>
                    <div class="stat-label">Records Extracted</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgConfidence">0%</div>
                    <div class="stat-label">Avg Confidence</div>
                </div>
            </div>
        </div>

        <a href="index.html" class="nav-link">Back to Home</a>
    </div>

    <script>
        // Global state
        let currentClassification = null;
        let currentSession = null;
        let selectedMethod = null;
        let catalogFilms = [];

        const API_BASE = window.location.hostname === 'localhost'
            ? 'http://localhost:3000/api'
            : '/api';

        async function analyzeUrl() {
            const url = document.getElementById('sourceUrl').value.trim();
            if (!url) {
                alert('Please enter a URL');
                return;
            }

            const btn = document.getElementById('analyzeBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Analyzing...';

            try {
                // Use smart-extract endpoint for intelligent routing
                const response = await fetch(`${API_BASE}/contribute/smart-extract`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Analysis failed');
                }

                currentClassification = data;
                displayClassification(data);

                // Check for special handling (FamilySearch catalog)
                if (data.specialHandling?.type === 'familysearch_catalog') {
                    await loadCatalogFilms(url);
                } else {
                    document.getElementById('extractionOptions').classList.add('visible');
                }

            } catch (error) {
                console.error('Analysis error:', error);
                alert('Error analyzing URL: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Analyze Source';
            }
        }

        function displayClassification(data) {
            const result = document.getElementById('classificationResult');
            result.classList.add('visible');

            // Set badge
            const badge = document.getElementById('sourceBadge');
            badge.textContent = data.classification.sourceType.toUpperCase();
            badge.className = 'source-badge ' + data.classification.sourceType;

            // Set details
            document.getElementById('sourceName').textContent = data.classification.sourceName;
            document.getElementById('sourceMessage').textContent = data.message;

            const confidence = Math.round(data.classification.confidence * 100);
            document.getElementById('confidenceValue').textContent = confidence + '%';
            document.getElementById('confidenceFill').style.width = confidence + '%';

            document.getElementById('extractionMethod').textContent = formatMethod(data.recommendedMethod);
            document.getElementById('expectedData').textContent = data.expectedDataTypes.join(', ').replace(/_/g, ' ');
            document.getElementById('autoConfirm').textContent = data.classification.shouldAutoConfirm
                ? 'Yes - Primary Source'
                : 'No - Requires Review';
        }

        function formatMethod(method) {
            const methods = {
                'msa_ocr': 'PDF Download + OCR',
                'familysearch_catalog': 'Catalog Analysis',
                'familysearch_ocr': 'FamilySearch Viewer + OCR',
                'html_table': 'HTML Table Extraction',
                'ocr_with_verification': 'OCR + Human Verification',
                'manual': 'Manual Entry'
            };
            return methods[method] || method.replace(/_/g, ' ');
        }

        async function loadCatalogFilms(catalogUrl) {
            try {
                const response = await fetch(`${API_BASE}/contribute/familysearch-catalog`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ catalogUrl, autoQueue: false })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error);
                }

                catalogFilms = data.films;
                displayCatalogFilms(data.films);
                document.getElementById('catalogFilms').style.display = 'block';

            } catch (error) {
                console.error('Catalog load error:', error);
                alert('Error loading catalog: ' + error.message);
            }
        }

        function displayCatalogFilms(films) {
            const list = document.getElementById('filmList');
            list.innerHTML = films.map((film, idx) => `
                <div class="film-item ${film.completed ? 'completed' : ''}" data-index="${idx}">
                    <div class="film-info">
                        <input type="checkbox" id="film${idx}" ${film.completed ? 'disabled' : 'checked'}>
                        <label for="film${idx}">
                            <h4>${film.title || 'Film ' + film.filmNumber}</h4>
                            <div class="meta">Film #${film.filmNumber} ${film.imageCount ? '(' + film.imageCount + ' images)' : ''}</div>
                        </label>
                    </div>
                    <span class="film-status ${film.completed ? 'completed' : 'pending'}">
                        ${film.completed ? 'Completed' : 'Ready'}
                    </span>
                </div>
            `).join('');
        }

        async function queueSelectedFilms() {
            const selected = [];
            catalogFilms.forEach((film, idx) => {
                const checkbox = document.querySelector(`#film${idx}`);
                if (checkbox && checkbox.checked) {
                    selected.push(film);
                }
            });

            if (selected.length === 0) {
                alert('Please select at least one film');
                return;
            }

            await queueFilms(selected);
        }

        async function queueAllFilms() {
            const unprocessed = catalogFilms.filter(f => !f.completed);
            if (unprocessed.length === 0) {
                alert('All films have already been processed');
                return;
            }
            await queueFilms(unprocessed);
        }

        async function queueFilms(films) {
            addLog('info', `Queueing ${films.length} films for processing...`);
            document.getElementById('statusArea').classList.add('visible');

            try {
                const url = document.getElementById('sourceUrl').value.trim();
                const response = await fetch(`${API_BASE}/contribute/familysearch-catalog`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        catalogUrl: url,
                        autoQueue: true
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error);
                }

                addLog('success', data.message);

                if (data.queueResult?.queued?.length > 0) {
                    data.queueResult.queued.forEach(film => {
                        addLog('success', `Queued: ${film.title || 'Film ' + film.filmNumber}`);
                    });
                }

                if (data.queueResult?.skipped?.length > 0) {
                    data.queueResult.skipped.forEach(film => {
                        addLog('info', `Skipped: ${film.title || 'Film ' + film.filmNumber} - ${film.reason}`);
                    });
                }

            } catch (error) {
                addLog('error', 'Queue error: ' + error.message);
            }
        }

        function selectMethod(method) {
            selectedMethod = method;

            // Update UI
            document.querySelectorAll('.option-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('method' + method.charAt(0).toUpperCase() + method.slice(1)).classList.add('selected');
            document.getElementById('startExtractionBtn').disabled = false;
        }

        async function startExtraction() {
            if (!selectedMethod || !currentClassification) {
                alert('Please analyze a URL and select a method first');
                return;
            }

            const url = document.getElementById('sourceUrl').value.trim();
            document.getElementById('statusArea').classList.add('visible');
            addLog('info', 'Starting contribution session...');

            try {
                // Start contribution session
                const startResponse = await fetch(`${API_BASE}/contribute/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });

                const startData = await startResponse.json();

                if (!startData.success) {
                    throw new Error(startData.error);
                }

                currentSession = startData.sessionId;
                addLog('success', `Session started: ${currentSession.substring(0, 8)}...`);

                // Handle based on method
                if (selectedMethod === 'auto') {
                    await runAutoExtraction();
                } else if (selectedMethod === 'screenshots') {
                    showScreenshotUpload();
                } else if (selectedMethod === 'paste') {
                    showTextPaste();
                }

            } catch (error) {
                addLog('error', 'Session error: ' + error.message);
            }
        }

        async function runAutoExtraction() {
            addLog('info', 'Starting automatic extraction...');

            try {
                // Describe the content
                const descResponse = await fetch(`${API_BASE}/contribute/${currentSession}/describe`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        description: `Automatic extraction of ${currentClassification.classification.sourceName}. ` +
                            `Expected data types: ${currentClassification.expectedDataTypes.join(', ')}`
                    })
                });

                const descData = await descResponse.json();
                addLog('success', 'Content described, confirming structure...');

                // Confirm structure
                const confirmResponse = await fetch(`${API_BASE}/contribute/${currentSession}/confirm`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ confirmed: true })
                });

                const confirmData = await confirmResponse.json();
                addLog('success', 'Structure confirmed, starting extraction...');

                // Start extraction
                const extractResponse = await fetch(`${API_BASE}/contribute/${currentSession}/extract`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ method: 'auto_extract' })
                });

                const extractData = await extractResponse.json();

                if (extractData.success) {
                    addLog('success', `Extraction started: ${extractData.extractionId?.substring(0, 8)}...`);
                    pollExtractionStatus(extractData.extractionId);
                } else {
                    throw new Error(extractData.error || 'Extraction failed');
                }

            } catch (error) {
                addLog('error', 'Extraction error: ' + error.message);
            }
        }

        async function pollExtractionStatus(extractionId) {
            try {
                const response = await fetch(`${API_BASE}/contribute/${currentSession}/extraction/${extractionId}/status`);
                const data = await response.json();

                if (data.status === 'processing') {
                    addLog('info', `Processing... ${data.progress || ''}`);
                    setTimeout(() => pollExtractionStatus(extractionId), 3000);
                } else if (data.status === 'completed') {
                    addLog('success', `Extraction complete! ${data.rowCount} records extracted`);
                    showResults(data);
                } else if (data.status === 'failed') {
                    addLog('error', `Extraction failed: ${data.error}`);
                } else {
                    setTimeout(() => pollExtractionStatus(extractionId), 3000);
                }
            } catch (error) {
                addLog('error', 'Status check error: ' + error.message);
                setTimeout(() => pollExtractionStatus(extractionId), 5000);
            }
        }

        function showResults(data) {
            const summary = document.getElementById('resultsSummary');
            summary.classList.add('visible');
            document.getElementById('recordsExtracted').textContent = data.rowCount || 0;
            document.getElementById('avgConfidence').textContent =
                (data.avgConfidence ? Math.round(data.avgConfidence * 100) : 0) + '%';
        }

        function showScreenshotUpload() {
            addLog('info', 'Screenshot upload not yet implemented in unified page');
            addLog('info', 'Use contribute-simplified.html for screenshot uploads');
        }

        function showTextPaste() {
            addLog('info', 'Text paste not yet implemented in unified page');
            addLog('info', 'Use contribute-simplified.html for text paste');
        }

        function addLog(type, message) {
            const log = document.getElementById('statusLog');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            entry.innerHTML = `<span class="timestamp">[${time}]</span> ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        // Enter key to analyze
        document.getElementById('sourceUrl').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                analyzeUrl();
            }
        });
    </script>
</body>
</html>
