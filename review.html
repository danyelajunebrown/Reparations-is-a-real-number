<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reparations ∈ ℝ</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; color: #eee; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        h1 { color: #ffd700; margin-bottom: 20px; }
        .stats { background: #16213e; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 30px; }
        .stat { text-align: center; }
        .stat-value { font-size: 2em; color: #ffd700; }
        .stat-label { font-size: 0.9em; color: #888; }

        .layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        .document-viewer { background: #16213e; border-radius: 8px; padding: 20px; }
        .document-viewer h2 { color: #ffd700; margin-bottom: 15px; }
        .document-viewer iframe { width: 100%; height: 600px; border: none; border-radius: 4px; }

        .review-list { background: #16213e; border-radius: 8px; padding: 20px; max-height: 700px; overflow-y: auto; }
        .review-list h2 { color: #ffd700; margin-bottom: 15px; }

        .review-item { background: #0f3460; border-radius: 8px; padding: 15px; margin-bottom: 10px; }
        .review-item.approved { opacity: 0.5; border-left: 4px solid #4CAF50; }
        .review-item.rejected { opacity: 0.5; border-left: 4px solid #f44336; }

        .review-name { font-size: 1.3em; color: #fff; margin-bottom: 8px; }
        .review-meta { font-size: 0.9em; color: #888; margin-bottom: 10px; }
        .review-meta span { margin-right: 15px; }
        .review-notes { font-size: 0.9em; color: #aaa; margin-bottom: 10px; font-style: italic; }

        .review-actions { display: flex; gap: 10px; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        .btn-approve { background: #4CAF50; color: white; }
        .btn-approve:hover { background: #45a049; }
        .btn-reject { background: #f44336; color: white; }
        .btn-reject:hover { background: #da190b; }
        .btn-edit { background: #2196F3; color: white; }
        .btn-edit:hover { background: #1976D2; }

        .bulk-actions { margin-bottom: 20px; }
        .btn-bulk { padding: 12px 24px; font-size: 1em; }

        .loading { text-align: center; padding: 40px; color: #888; }
        .error { background: #f44336; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .success { background: #4CAF50; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Human Review Queue</h1>

        <div id="message"></div>

        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="pending-count">-</div>
                <div class="stat-label">Pending Review</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="approved-count">-</div>
                <div class="stat-label">Approved</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="document-name">James Hopewell Will (1811)</div>
                <div class="stat-label">Source Document</div>
            </div>
        </div>

        <div class="bulk-actions">
            <button class="btn btn-approve btn-bulk" onclick="approveAll()">Approve All Pending</button>
        </div>

        <div class="layout">
            <div class="document-viewer">
                <h2>Source Document</h2>
                <iframe id="doc-frame" src="about:blank"></iframe>
                <p style="margin-top: 10px; color: #888;">
                    <a href="#" id="doc-link" target="_blank" style="color: #ffd700;">Open in new tab</a> |
                    <a href="#" id="doc-page2" onclick="loadPage(2)" style="color: #ffd700;">View Page 2</a>
                </p>
            </div>

            <div class="review-list">
                <h2>Extracted Names</h2>
                <div id="items-container">
                    <div class="loading">Loading review items...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let documentUrls = {};

        async function loadDocument() {
            try {
                const response = await fetch(`${API_BASE}/documents/james-hopewell-will-1817/access`);
                const data = await response.json();
                if (data.success) {
                    documentUrls = data;
                    document.getElementById('doc-frame').src = data.viewUrl;
                    document.getElementById('doc-link').href = data.viewUrl;
                }
            } catch (e) {
                console.error('Failed to load document:', e);
            }
        }

        async function loadPage(pageNum) {
            // For now just show a message - would need separate page URLs
            alert('Page 2 viewing requires separate document access. The will is 2 pages.');
        }

        async function loadReviewItems() {
            try {
                const response = await fetch(`${API_BASE}/contribute/review-queue`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error);
                }

                document.getElementById('pending-count').textContent = data.count;

                const container = document.getElementById('items-container');

                if (data.count === 0) {
                    container.innerHTML = '<div class="loading">No items pending review. All done!</div>';
                    return;
                }

                container.innerHTML = data.items.map(item => `
                    <div class="review-item" id="item-${item.id}">
                        <div class="review-name">${escapeHtml(item.unconfirmed_name)}</div>
                        <div class="review-meta">
                            <span>Gender: ${item.source_context?.gender || 'unknown'}</span>
                            <span>Location: ${escapeHtml(item.location_context || 'N/A')}</span>
                        </div>
                        <div class="review-notes">${escapeHtml(item.source_context?.notes || '')}</div>
                        <div class="review-actions">
                            <button class="btn btn-approve" onclick="approveItem(${item.id}, '${escapeHtml(item.unconfirmed_name)}')">Approve</button>
                            <button class="btn btn-reject" onclick="rejectItem(${item.id})">Reject</button>
                        </div>
                    </div>
                `).join('');

            } catch (e) {
                console.error('Failed to load review items:', e);
                document.getElementById('items-container').innerHTML =
                    `<div class="error">Error: ${e.message}</div>`;
            }
        }

        async function approveItem(id, name) {
            try {
                const response = await fetch(`${API_BASE}/contribute/review-queue/${id}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ full_name: name })
                });
                const data = await response.json();

                if (data.success) {
                    document.getElementById(`item-${id}`).classList.add('approved');
                    showMessage('success', `Approved: ${name}`);
                    updateCounts();
                } else {
                    showMessage('error', data.error);
                }
            } catch (e) {
                showMessage('error', e.message);
            }
        }

        async function rejectItem(id) {
            const reason = prompt('Reason for rejection (optional):');
            try {
                const response = await fetch(`${API_BASE}/contribute/review-queue/${id}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason })
                });
                const data = await response.json();

                if (data.success) {
                    document.getElementById(`item-${id}`).classList.add('rejected');
                    showMessage('success', 'Item rejected');
                    updateCounts();
                } else {
                    showMessage('error', data.error);
                }
            } catch (e) {
                showMessage('error', e.message);
            }
        }

        async function approveAll() {
            if (!confirm('Approve all pending items? This will create enslaved individual records for all names.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/contribute/review-queue/approve-all`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                if (data.success) {
                    showMessage('success', data.message);
                    loadReviewItems();
                } else {
                    showMessage('error', data.error);
                }
            } catch (e) {
                showMessage('error', e.message);
            }
        }

        function updateCounts() {
            const pending = document.querySelectorAll('.review-item:not(.approved):not(.rejected)').length;
            const approved = document.querySelectorAll('.review-item.approved').length;
            document.getElementById('pending-count').textContent = pending;
            document.getElementById('approved-count').textContent = approved;
        }

        function showMessage(type, text) {
            const el = document.getElementById('message');
            el.className = type;
            el.textContent = text;
            setTimeout(() => { el.textContent = ''; el.className = ''; }, 3000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        // Initialize
        loadDocument();
        loadReviewItems();
    </script>
</body>
</html>
