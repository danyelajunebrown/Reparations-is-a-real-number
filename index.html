<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reparations Is A Real Number</title>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0e27;
            color: #e0e0e0;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* ============================================
           FULL SCREEN HERO SECTION
           ============================================ */
        .hero-container {
            min-height: calc(100vh - 70px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px 100px;
            background: radial-gradient(ellipse at center, #1a1e3f 0%, #0a0e27 70%);
            position: relative;
        }

        .hero-title {
            text-align: center;
            margin-bottom: 50px;
        }

        .hero-title h1 {
            font-size: 3.5em;
            color: #64c8ff;
            text-shadow: 0 0 40px rgba(100, 200, 255, 0.4);
            margin-bottom: 15px;
            letter-spacing: -1px;
        }

        .hero-title .subtitle {
            font-size: 1.3em;
            color: #9aa5b1;
            font-weight: 300;
        }

        /* Live Stats Ribbon */
        .stats-ribbon {
            display: flex;
            gap: 60px;
            margin-bottom: 50px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #64c8ff;
            text-shadow: 0 0 20px rgba(100, 200, 255, 0.3);
        }

        .stat-label {
            font-size: 0.85em;
            color: #9aa5b1;
            margin-top: 5px;
        }

        /* Search Box - Main Focus */
        .search-hero {
            width: 100%;
            max-width: 800px;
            margin-bottom: 40px;
        }

        .search-input-wrapper {
            display: flex;
            gap: 0;
            background: rgba(30, 40, 70, 0.8);
            border: 2px solid rgba(100, 200, 255, 0.5);
            border-radius: 60px;
            overflow: hidden;
            box-shadow: 0 10px 50px rgba(100, 200, 255, 0.2);
            transition: all 0.3s;
        }

        .search-input-wrapper:focus-within {
            border-color: #64c8ff;
            box-shadow: 0 15px 60px rgba(100, 200, 255, 0.4);
        }

        .search-input-wrapper input {
            flex: 1;
            padding: 20px 30px;
            background: transparent;
            border: none;
            color: #e0e0e0;
            font-size: 1.2em;
            outline: none;
        }

        .search-input-wrapper input::placeholder {
            color: #6b7280;
        }

        .search-btn {
            padding: 20px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .search-btn:hover {
            background: linear-gradient(135deg, #7c8fef 0%, #8a5cb8 100%);
        }

        .search-hint {
            text-align: center;
            color: #6b7280;
            font-size: 0.9em;
            margin-top: 15px;
        }

        /* Search Results Panel */
        .search-results-panel {
            width: 100%;
            max-width: 900px;
            max-height: 60vh;
            overflow-y: auto;
            background: rgba(20, 25, 50, 0.95);
            border: 1px solid rgba(100, 200, 255, 0.3);
            border-radius: 15px;
            display: none;
            margin-top: 20px;
        }

        .search-results-panel.active {
            display: block;
        }

        .results-header {
            padding: 20px;
            border-bottom: 1px solid rgba(100, 200, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: rgba(20, 25, 50, 0.98);
        }

        .results-header h3 {
            color: #64c8ff;
            font-size: 1.1em;
        }

        .results-close {
            background: transparent;
            border: none;
            color: #9aa5b1;
            font-size: 1.5em;
            cursor: pointer;
        }

        .results-list {
            padding: 10px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(30, 40, 70, 0.5);
            margin: 8px 0;
            border-radius: 10px;
            border-left: 4px solid #64c8ff;
            cursor: pointer;
            transition: all 0.2s;
        }

        .result-item:hover {
            background: rgba(40, 50, 80, 0.8);
            transform: translateX(5px);
        }

        .result-item.slaveholder {
            border-left-color: #ff6464;
        }

        .result-item.enslaved {
            border-left-color: #64ff64;
        }

        .result-name {
            font-weight: 600;
            color: #e0e0e0;
            font-size: 1.05em;
        }

        .result-meta {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .result-type {
            font-size: 0.8em;
            padding: 4px 10px;
            border-radius: 20px;
            background: rgba(100, 200, 255, 0.2);
            color: #64c8ff;
        }

        .result-type.slaveholder {
            background: rgba(255, 100, 100, 0.2);
            color: #ff6464;
        }

        .result-type.enslaved {
            background: rgba(100, 255, 100, 0.2);
            color: #64ff64;
        }

        .result-source {
            font-size: 0.75em;
            color: #6b7280;
        }

        .result-confidence {
            font-size: 0.75em;
            color: #9aa5b1;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .quick-action-btn {
            padding: 12px 25px;
            background: rgba(100, 200, 255, 0.1);
            border: 1px solid rgba(100, 200, 255, 0.3);
            border-radius: 30px;
            color: #64c8ff;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }

        .quick-action-btn:hover {
            background: rgba(100, 200, 255, 0.2);
            border-color: #64c8ff;
            transform: translateY(-2px);
        }

        /* System Status Indicator */
        .system-status-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: rgba(20, 25, 50, 0.8);
            border: 1px solid rgba(100, 255, 100, 0.3);
            border-radius: 25px;
            font-size: 0.85em;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #64ff64;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(100, 255, 100, 0.4); }
            50% { opacity: 0.7; box-shadow: 0 0 0 8px rgba(100, 255, 100, 0); }
        }

        /* ============================================
           BOTTOM FEATURE BAR
           ============================================ */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: rgba(10, 14, 39, 0.98);
            border-top: 2px solid rgba(100, 200, 255, 0.3);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 20px;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 10px;
            text-decoration: none;
            color: #9aa5b1;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(100, 200, 255, 0.15);
            color: #64c8ff;
        }

        .nav-icon {
            font-size: 1.5em;
        }

        .nav-label {
            font-size: 0.75em;
            font-weight: 500;
        }

        /* ============================================
           FEATURE PANELS (Slide-up from bottom)
           ============================================ */
        .feature-panel {
            position: fixed;
            bottom: 70px;
            left: 0;
            right: 0;
            height: 60vh;
            background: rgba(20, 25, 50, 0.98);
            border-top: 2px solid rgba(100, 200, 255, 0.4);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 999;
            overflow-y: auto;
            padding: 30px;
        }

        .feature-panel.active {
            transform: translateY(0);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(100, 200, 255, 0.2);
        }

        .panel-header h2 {
            color: #64c8ff;
            font-size: 1.5em;
        }

        .panel-close {
            background: rgba(255, 100, 100, 0.2);
            border: 1px solid rgba(255, 100, 100, 0.4);
            color: #ff6464;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
        }

        /* Formula Panel Styles */
        .formula-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .formula-card {
            background: rgba(30, 40, 70, 0.6);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(100, 200, 255, 0.2);
        }

        .formula-card h3 {
            color: #ffaa00;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .formula-card p {
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
        }

        .formula-result-box {
            background: rgba(100, 255, 100, 0.1);
            border: 1px solid rgba(100, 255, 100, 0.3);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }

        .formula-result-box .amount {
            font-size: 2.5em;
            color: #64ff64;
            font-weight: bold;
        }

        .formula-result-box .label {
            color: #9aa5b1;
            font-size: 0.9em;
            margin-top: 5px;
        }

        /* Documents Panel Styles */
        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .document-card {
            background: rgba(30, 40, 70, 0.6);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #64c8ff;
            cursor: pointer;
            transition: all 0.2s;
        }

        .document-card:hover {
            background: rgba(40, 50, 80, 0.8);
            transform: translateY(-3px);
        }

        .document-card .doc-name {
            color: #64c8ff;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .document-card .doc-meta {
            font-size: 0.85em;
            color: #9aa5b1;
        }

        /* Chat Panel Styles */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(60vh - 120px);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: rgba(10, 14, 39, 0.6);
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .chat-message {
            margin: 10px 0;
            padding: 12px 15px;
            border-radius: 10px;
            max-width: 80%;
        }

        .chat-message.user {
            background: rgba(100, 200, 255, 0.2);
            margin-left: auto;
            text-align: right;
        }

        .chat-message.assistant {
            background: rgba(30, 40, 70, 0.8);
            border-left: 3px solid #64c8ff;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
        }

        .chat-input-wrapper input {
            flex: 1;
            padding: 15px;
            background: rgba(30, 40, 70, 0.6);
            border: 1px solid rgba(100, 200, 255, 0.3);
            border-radius: 10px;
            color: #e0e0e0;
            font-size: 1em;
            outline: none;
        }

        .chat-input-wrapper button {
            padding: 15px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        /* Upload Panel Styles */
        .upload-zone {
            border: 2px dashed rgba(100, 200, 255, 0.4);
            border-radius: 15px;
            padding: 50px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-zone:hover {
            border-color: #64c8ff;
            background: rgba(100, 200, 255, 0.05);
        }

        .upload-zone .icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .upload-zone .text {
            color: #9aa5b1;
            font-size: 1.1em;
        }

        .upload-zone .hint {
            color: #6b7280;
            font-size: 0.85em;
            margin-top: 10px;
        }

        #fileInput {
            display: none;
        }

        /* Wallet Button */
        .wallet-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: rgba(255, 100, 100, 0.1);
            border: 1px solid rgba(255, 100, 100, 0.3);
            border-radius: 25px;
            color: #ff6464;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .wallet-btn:hover {
            background: rgba(255, 100, 100, 0.2);
        }

        .wallet-btn.connected {
            background: rgba(100, 255, 100, 0.1);
            border-color: rgba(100, 255, 100, 0.3);
            color: #64ff64;
        }

        /* Document Viewer Modal */
        .document-viewer-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(10, 14, 39, 0.98);
            display: none;
            z-index: 9999;
            flex-direction: row;
        }

        .document-viewer-modal.active {
            display: flex;
        }

        .doc-viewer-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        .doc-viewer-content {
            max-width: 100%;
            max-height: 100%;
        }

        .doc-viewer-content img,
        .doc-viewer-content iframe {
            max-width: 90%;
            max-height: 85vh;
            border: 2px solid rgba(100, 200, 255, 0.3);
            border-radius: 8px;
        }

        .doc-viewer-sidebar {
            width: 350px;
            background: rgba(26, 30, 63, 0.95);
            border-left: 2px solid rgba(100, 200, 255, 0.3);
            padding: 25px;
            overflow-y: auto;
        }

        .doc-viewer-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .doc-control-btn {
            background: rgba(100, 200, 255, 0.2);
            border: 1px solid rgba(100, 200, 255, 0.5);
            color: #64c8ff;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .doc-control-btn:hover {
            background: rgba(100, 200, 255, 0.3);
        }

        .doc-control-btn.close {
            background: rgba(255, 100, 100, 0.2);
            border-color: rgba(255, 100, 100, 0.5);
            color: #ff6464;
        }

        /* Notification Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 10000;
            transform: translateX(120%);
            transition: transform 0.3s;
        }

        .toast.visible {
            transform: translateX(0);
        }

        .toast.success {
            background: linear-gradient(135deg, #4caf50, #388e3c);
            color: white;
        }

        .toast.error {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .toast.info {
            background: linear-gradient(135deg, #2196f3, #1976d2);
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .hero-title h1 {
                font-size: 2em;
            }

            .stats-ribbon {
                gap: 30px;
            }

            .stat-number {
                font-size: 1.8em;
            }

            .search-input-wrapper {
                flex-direction: column;
                border-radius: 15px;
            }

            .search-btn {
                border-radius: 0 0 13px 13px;
            }

            .nav-label {
                display: none;
            }

            .feature-panel {
                height: 80vh;
            }

            .doc-viewer-sidebar {
                display: none;
            }
        }

        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(100, 200, 255, 0.2);
            border-top-color: #64c8ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Hero Section - Full Screen -->
    <div class="hero-container">
        <!-- Wallet Button -->
        <button class="wallet-btn" id="walletBtn" onclick="connectWallet()">
            Connect Wallet
        </button>

        <!-- System Status -->
        <div class="system-status-badge">
            <div class="status-dot"></div>
            <span id="systemStatus">Connecting...</span>
        </div>

        <!-- Title -->
        <div class="hero-title">
            <h1>Reparations Is A Real Number</h1>
            <p class="subtitle">Documenting American slavery for accountability</p>
        </div>

        <!-- Live Stats -->
        <div class="stats-ribbon">
            <div class="stat-item">
                <div class="stat-number" id="statRecords">--</div>
                <div class="stat-label">Database Records</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="statSlaveholders">--</div>
                <div class="stat-label">Slaveholders Identified</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="statEnslaved">--</div>
                <div class="stat-label">Enslaved People</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="statSources">--</div>
                <div class="stat-label">Source Archives</div>
            </div>
        </div>

        <!-- Search Box -->
        <div class="search-hero">
            <div class="search-input-wrapper">
                <input
                    type="text"
                    id="searchInput"
                    placeholder="Search by name, location, or document..."
                    onkeypress="if(event.key === 'Enter') performSearch()"
                />
                <button class="search-btn" onclick="performSearch()">Search</button>
            </div>
            <p class="search-hint">Try: "James Hopewell", "Montgomery County", or "Nancy D'Wolf"</p>
        </div>

        <!-- Search Results Panel -->
        <div class="search-results-panel" id="searchResultsPanel">
            <div class="results-header">
                <h3 id="resultsTitle">Search Results</h3>
                <button class="results-close" onclick="closeSearchResults()">&times;</button>
            </div>
            <div class="results-list" id="resultsList">
                <!-- Results populate here -->
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <a href="contribute-v2.html" class="quick-action-btn">Contribute Data</a>
            <a href="bibliography.html" class="quick-action-btn">View Sources</a>
            <button class="quick-action-btn" onclick="openPanel('formula')">Calculate Reparations</button>
        </div>
    </div>

    <!-- Bottom Navigation Bar -->
    <div class="bottom-bar">
        <div class="nav-item" onclick="openPanel('documents')">
            <span class="nav-icon">üìú</span>
            <span class="nav-label">Documents</span>
        </div>
        <div class="nav-item" onclick="openPanel('formula')">
            <span class="nav-icon">üìä</span>
            <span class="nav-label">Formula</span>
        </div>
        <div class="nav-item active" onclick="closeAllPanels()">
            <span class="nav-icon">üîç</span>
            <span class="nav-label">Search</span>
        </div>
        <div class="nav-item" onclick="openPanel('chat')">
            <span class="nav-icon">üí¨</span>
            <span class="nav-label">Assistant</span>
        </div>
        <div class="nav-item" onclick="openPanel('upload')">
            <span class="nav-icon">üì§</span>
            <span class="nav-label">Upload</span>
        </div>
    </div>

    <!-- Feature Panels -->

    <!-- Documents Panel -->
    <div class="feature-panel" id="documentsPanel">
        <div class="panel-header">
            <h2>Documented Records</h2>
            <button class="panel-close" onclick="closePanel('documents')">&times;</button>
        </div>
        <div class="documents-grid" id="documentsList">
            <div style="text-align: center; color: #9aa5b1; padding: 40px;">
                <div class="spinner" style="margin: 0 auto 15px;"></div>
                Loading documents...
            </div>
        </div>
    </div>

    <!-- Formula Panel -->
    <div class="feature-panel" id="formulaPanel">
        <div class="panel-header">
            <h2>Reparations Calculation Formula</h2>
            <button class="panel-close" onclick="closePanel('formula')">&times;</button>
        </div>
        <div class="formula-grid">
            <div class="formula-card">
                <h3>Wage Theft</h3>
                <p>Count √ó $120/day √ó Years √ó 300 days √ó inflation</p>
            </div>
            <div class="formula-card">
                <h3>Human Dignity Damages</h3>
                <p>Count √ó $15,000 √ó Years √ó 1.5 multiplier</p>
            </div>
            <div class="formula-card">
                <h3>Profit Share</h3>
                <p>Count √ó $300/year √ó Years √ó inflation √ó 40%</p>
            </div>
            <div class="formula-card">
                <h3>Compound Interest (4%)</h3>
                <p>Subtotal √ó (1.04^224 - 1)</p>
            </div>
            <div class="formula-card">
                <h3>Delayed Justice (2%)</h3>
                <p>Subtotal √ó 2% √ó 224 years</p>
            </div>
            <div class="formula-result-box">
                <div class="amount">$2,200,000</div>
                <div class="label">Average Per Person (25 years enslavement)</div>
            </div>
        </div>
    </div>

    <!-- Chat Panel -->
    <div class="feature-panel" id="chatPanel">
        <div class="panel-header">
            <h2>Research Assistant</h2>
            <button class="panel-close" onclick="closePanel('chat')">&times;</button>
        </div>
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message assistant">
                    Ask me about the database: owners, documents, enslaved people, families, or statistics.
                </div>
            </div>
            <div class="chat-input-wrapper">
                <input
                    type="text"
                    id="chatInput"
                    placeholder="Ask about James Hopewell, family structures, statistics..."
                    onkeypress="if(event.key === 'Enter') sendChat()"
                />
                <button onclick="sendChat()">Send</button>
            </div>
        </div>
    </div>

    <!-- Upload Panel -->
    <div class="feature-panel" id="uploadPanel">
        <div class="panel-header">
            <h2>Upload Documents</h2>
            <button class="panel-close" onclick="closePanel('upload')">&times;</button>
        </div>
        <input type="file" id="fileInput" multiple accept=".pdf,.jpg,.jpeg,.png,.heic" onchange="handleFileSelect(event)" />
        <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
            <div class="icon">üìÑ</div>
            <div class="text">Drop files here or click to browse</div>
            <div class="hint">Supports PDF, JPG, PNG, HEIC</div>
        </div>
        <div id="uploadQueue" style="margin-top: 20px;"></div>
    </div>

    <!-- Document Viewer Modal -->
    <div class="document-viewer-modal" id="documentViewer">
        <div class="doc-viewer-main">
            <div class="doc-viewer-controls">
                <button class="doc-control-btn" onclick="zoomDocument()">Zoom</button>
                <button class="doc-control-btn" onclick="downloadDocument()">Download</button>
                <button class="doc-control-btn close" onclick="closeDocViewer()">&times; Close</button>
            </div>
            <div class="doc-viewer-content" id="docViewerContent">
                <!-- Document renders here -->
            </div>
        </div>
        <div class="doc-viewer-sidebar" id="docViewerSidebar">
            <h3 style="color: #64c8ff; margin-bottom: 20px;">Document Details</h3>
            <div id="docMetadata"></div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:3000'
            : 'https://reparations-platform.onrender.com';

        console.log('API Base URL:', API_BASE_URL);

        // ============================================
        // INITIALIZATION
        // ============================================
        let backendReady = false;

        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });

        async function initializeApp() {
            await pingBackend();
            if (backendReady) {
                loadStats();
            }
        }

        async function pingBackend() {
            const maxRetries = 20;
            let retries = 0;

            while (retries < maxRetries && !backendReady) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/health`, {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.status === 'ok') {
                            backendReady = true;
                            document.getElementById('systemStatus').textContent = 'System Online';
                            showToast('Connected to backend', 'success');
                            return;
                        }
                    }
                } catch (error) {
                    console.log(`Backend not ready: ${error.message}`);
                }

                retries++;
                document.getElementById('systemStatus').textContent = `Connecting (${retries}/${maxRetries})...`;
                await new Promise(resolve => setTimeout(resolve, 6000));
            }

            if (!backendReady) {
                document.getElementById('systemStatus').textContent = 'Offline';
                showToast('Backend not responding', 'error');
            }
        }

        // ============================================
        // STATS
        // ============================================
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/contribute/stats`);
                if (response.ok) {
                    const data = await response.json();

                    document.getElementById('statRecords').textContent = formatNumber(data.total_records || 0);
                    document.getElementById('statSlaveholders').textContent = formatNumber(data.slaveholders || 0);
                    document.getElementById('statEnslaved').textContent = formatNumber(data.enslaved || 0);
                    document.getElementById('statSources').textContent = data.sources || '--';
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        // ============================================
        // SEARCH
        // ============================================
        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                showToast('Please enter a search term', 'info');
                return;
            }

            const resultsList = document.getElementById('resultsList');
            resultsList.innerHTML = '<div style="text-align: center; padding: 30px;"><div class="spinner" style="margin: 0 auto;"></div></div>';
            document.getElementById('searchResultsPanel').classList.add('active');

            try {
                // Search both documents and unconfirmed_persons in parallel
                const [docResponse, peopleResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/api/documents/owner/${encodeURIComponent(query)}`).catch(() => ({ ok: false })),
                    fetch(`${API_BASE_URL}/api/contribute/search/${encodeURIComponent(query)}`).catch(() => ({ ok: false }))
                ]);

                let allResults = [];

                // Process document results
                if (docResponse.ok) {
                    const docData = await docResponse.json();
                    if (docData.success && docData.documents) {
                        docData.documents.forEach(doc => {
                            allResults.push({
                                type: 'document',
                                name: doc.owner_name || doc.title,
                                source: 'Uploaded Documents',
                                confidence: 1.0,
                                id: doc.id
                            });
                        });
                    }
                }

                // Process people results
                if (peopleResponse.ok) {
                    const peopleData = await peopleResponse.json();
                    if (peopleData.success && peopleData.results) {
                        peopleData.results.forEach(person => {
                            allResults.push({
                                type: person.type || 'unknown',
                                name: person.name,
                                source: new URL(person.source_url || 'https://unknown').hostname,
                                confidence: person.confidence_score || 0,
                                sourceUrl: person.source_url,
                                id: person.id
                            });
                        });
                    }
                }

                // Display results
                document.getElementById('resultsTitle').textContent = `Found ${allResults.length} results for "${query}"`;

                if (allResults.length === 0) {
                    resultsList.innerHTML = '<div style="text-align: center; padding: 40px; color: #9aa5b1;">No results found. Try a different search term.</div>';
                } else {
                    resultsList.innerHTML = allResults.map(r => `
                        <div class="result-item ${r.type}" onclick="viewResult('${r.type}', '${r.id}', '${r.sourceUrl || ''}')">
                            <div class="result-name">${escapeHtml(r.name)}</div>
                            <div class="result-meta">
                                <span class="result-type ${r.type}">${r.type}</span>
                                <span class="result-source">${r.source}</span>
                                ${r.confidence ? `<span class="result-confidence">${Math.round(r.confidence * 100)}%</span>` : ''}
                            </div>
                        </div>
                    `).join('');
                }

            } catch (error) {
                console.error('Search error:', error);
                resultsList.innerHTML = '<div style="text-align: center; padding: 40px; color: #ff6464;">Search failed. Please try again.</div>';
            }
        }

        function closeSearchResults() {
            document.getElementById('searchResultsPanel').classList.remove('active');
        }

        function viewResult(type, id, sourceUrl) {
            if (type === 'document') {
                openDocViewer(id);
            } else if (sourceUrl) {
                window.open(sourceUrl, '_blank');
            }
        }

        // ============================================
        // PANELS
        // ============================================
        function openPanel(panelId) {
            closeAllPanels();
            document.getElementById(`${panelId}Panel`).classList.add('active');

            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // Load content if needed
            if (panelId === 'documents') loadDocuments();
        }

        function closePanel(panelId) {
            document.getElementById(`${panelId}Panel`).classList.remove('active');

            // Reset nav to search
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.nav-item:nth-child(3)').classList.add('active');
        }

        function closeAllPanels() {
            document.querySelectorAll('.feature-panel').forEach(panel => {
                panel.classList.remove('active');
            });
        }

        // ============================================
        // DOCUMENTS
        // ============================================
        async function loadDocuments() {
            const container = document.getElementById('documentsList');

            try {
                const response = await fetch(`${API_BASE_URL}/api/documents`);
                if (response.ok) {
                    const data = await response.json();

                    if (data.documents && data.documents.length > 0) {
                        container.innerHTML = data.documents.map(doc => `
                            <div class="document-card" onclick="openDocViewer('${doc.id}')">
                                <div class="doc-name">${escapeHtml(doc.title || doc.original_filename)}</div>
                                <div class="doc-meta">
                                    ${doc.owner_name ? `Owner: ${escapeHtml(doc.owner_name)}` : ''}
                                    ${doc.document_date ? `<br>Date: ${doc.document_date}` : ''}
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<div style="text-align: center; color: #9aa5b1; padding: 40px;">No documents uploaded yet</div>';
                    }
                }
            } catch (error) {
                container.innerHTML = '<div style="text-align: center; color: #ff6464; padding: 40px;">Failed to load documents</div>';
            }
        }

        // ============================================
        // DOCUMENT VIEWER
        // ============================================
        async function openDocViewer(documentId) {
            document.getElementById('documentViewer').classList.add('active');
            const content = document.getElementById('docViewerContent');
            content.innerHTML = '<div style="text-align: center; padding: 50px;"><div class="spinner" style="margin: 0 auto;"></div><p style="margin-top: 15px; color: #9aa5b1;">Loading document...</p></div>';

            try {
                // Get document metadata
                const metaResponse = await fetch(`${API_BASE_URL}/api/documents/${documentId}`);
                const metaData = await metaResponse.json();

                if (metaData.success) {
                    const doc = metaData.document;

                    // Update sidebar
                    document.getElementById('docMetadata').innerHTML = `
                        <div style="margin-bottom: 15px;">
                            <div style="color: #9aa5b1; font-size: 0.85em;">Title</div>
                            <div style="color: #e0e0e0;">${escapeHtml(doc.title || 'Untitled')}</div>
                        </div>
                        ${doc.owner_name ? `
                        <div style="margin-bottom: 15px;">
                            <div style="color: #9aa5b1; font-size: 0.85em;">Owner</div>
                            <div style="color: #e0e0e0;">${escapeHtml(doc.owner_name)}</div>
                        </div>` : ''}
                        ${doc.document_date ? `
                        <div style="margin-bottom: 15px;">
                            <div style="color: #9aa5b1; font-size: 0.85em;">Date</div>
                            <div style="color: #e0e0e0;">${doc.document_date}</div>
                        </div>` : ''}
                        ${doc.document_type ? `
                        <div style="margin-bottom: 15px;">
                            <div style="color: #9aa5b1; font-size: 0.85em;">Type</div>
                            <div style="color: #e0e0e0;">${doc.document_type}</div>
                        </div>` : ''}
                    `;

                    // Get access URL
                    const accessResponse = await fetch(`${API_BASE_URL}/api/documents/${documentId}/access`);
                    const accessData = await accessResponse.json();

                    if (accessData.success) {
                        const mimeType = accessData.metadata?.mimeType || doc.mime_type;

                        if (mimeType && mimeType.includes('pdf')) {
                            content.innerHTML = `<iframe src="${accessData.viewUrl}" style="width: 100%; height: 85vh; border: none; border-radius: 8px;"></iframe>`;
                        } else {
                            content.innerHTML = `<img src="${accessData.viewUrl}" style="max-height: 85vh; border-radius: 8px;" />`;
                        }

                        window.currentDocDownloadUrl = accessData.downloadUrl;
                    } else {
                        throw new Error(accessData.error || 'Failed to access document');
                    }
                }
            } catch (error) {
                content.innerHTML = `<div style="text-align: center; padding: 50px; color: #ff6464;">Failed to load document: ${error.message}</div>`;
            }
        }

        function closeDocViewer() {
            document.getElementById('documentViewer').classList.remove('active');
        }

        function downloadDocument() {
            if (window.currentDocDownloadUrl) {
                window.open(window.currentDocDownloadUrl, '_blank');
            }
        }

        function zoomDocument() {
            const img = document.querySelector('#docViewerContent img');
            if (img) {
                img.style.transform = img.style.transform === 'scale(1.5)' ? 'scale(1)' : 'scale(1.5)';
            }
        }

        // ============================================
        // CHAT
        // ============================================
        async function sendChat() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            const messagesContainer = document.getElementById('chatMessages');

            // Add user message
            messagesContainer.innerHTML += `<div class="chat-message user">${escapeHtml(message)}</div>`;
            input.value = '';
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            try {
                const response = await fetch(`${API_BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                if (response.ok) {
                    const data = await response.json();
                    messagesContainer.innerHTML += `<div class="chat-message assistant">${data.response || 'No response'}</div>`;
                } else {
                    messagesContainer.innerHTML += `<div class="chat-message assistant">Sorry, I couldn't process that request.</div>`;
                }
            } catch (error) {
                messagesContainer.innerHTML += `<div class="chat-message assistant">Connection error. Please try again.</div>`;
            }

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ============================================
        // FILE UPLOAD
        // ============================================
        function handleFileSelect(event) {
            const files = event.target.files;
            const queue = document.getElementById('uploadQueue');

            queue.innerHTML = Array.from(files).map((file, i) => `
                <div style="padding: 10px; background: rgba(30, 40, 70, 0.6); margin: 8px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <span>${escapeHtml(file.name)}</span>
                    <span style="color: #9aa5b1; font-size: 0.85em;">${(file.size / 1024 / 1024).toFixed(2)} MB</span>
                </div>
            `).join('');

            if (files.length > 0) {
                queue.innerHTML += `
                    <button onclick="uploadFiles()" style="margin-top: 15px; padding: 12px 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; width: 100%;">
                        Upload ${files.length} file${files.length > 1 ? 's' : ''}
                    </button>
                `;
            }
        }

        async function uploadFiles() {
            const files = document.getElementById('fileInput').files;
            if (!files.length) return;

            const formData = new FormData();
            Array.from(files).forEach(file => formData.append('documents', file));

            try {
                showToast('Uploading...', 'info');

                const response = await fetch(`${API_BASE_URL}/api/documents/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    showToast('Upload successful!', 'success');
                    document.getElementById('uploadQueue').innerHTML = '';
                    document.getElementById('fileInput').value = '';
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                showToast('Upload failed: ' + error.message, 'error');
            }
        }

        // ============================================
        // WALLET
        // ============================================
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                showToast('Please install MetaMask', 'error');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const btn = document.getElementById('walletBtn');
                btn.textContent = accounts[0].slice(0, 6) + '...' + accounts[0].slice(-4);
                btn.classList.add('connected');
                showToast('Wallet connected', 'success');
            } catch (error) {
                showToast('Failed to connect wallet', 'error');
            }
        }

        // ============================================
        // UTILITIES
        // ============================================
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} visible`;

            setTimeout(() => {
                toast.classList.remove('visible');
            }, 3000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
