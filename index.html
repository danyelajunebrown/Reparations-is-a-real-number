<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reparations Ancestry Database</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.9.2/dist/sha3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #fff;
        }

        .genealogy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .person-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .person-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .person-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .person-info {
            font-size: 0.9em;
            opacity: 0.8;
            line-height: 1.5;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .btn-primary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #2196F3, #1976D2);
        }

        .blockchain-status {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 15px;
            border-radius: 10px;
            font-size: 0.9em;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .blockchain-connected {
            color: #27ae60;
        }

        .blockchain-warning {
            color: #e74c3c;
        }

        .blockchain-warning a {
            color: #3498db;
            text-decoration: none;
        }

        /* Popup Styles */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .popup-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: white;
            border-radius: 20px;
            padding: 0;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 1001;
            transition: all 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .popup.active {
            transform: translate(-50%, -50%) scale(1);
        }

        .popup-content {
            padding: 30px;
            color: #333;
        }

        .popup-title {
            font-size: 2.2em;
            margin-bottom: 25px;
            color: #2c3e50;
            text-align: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #999;
            z-index: 1002;
        }

        .close-btn:hover {
            color: #333;
        }

        .genealogy-section {
            margin-bottom: 25px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .section-title {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 10px;
            align-items: center;
        }

        .info-label {
            font-weight: 600;
            color: #555;
        }

        .info-value {
            color: #333;
        }

        .merkle-section {
            background: #e8f5e8;
            border-left: 4px solid #4CAF50;
        }

        .blockchain-submit-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .blockchain-submit-btn:hover {
            background: linear-gradient(45deg, #2980b9, #1f618d);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .blockchain-status {
                position: static;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Blockchain Status -->
        <div id="blockchain-status" class="blockchain-status">
            <p>üîÑ Connecting to blockchain...</p>
        </div>

        <!-- Header -->
        <div class="header">
            <h1>Reparations Ancestry Database</h1>
            <p>Blockchain-secured genealogy records for reparations tracking</p>
        </div>

        <!-- Stats -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="total-records">12</div>
                <div class="stat-label">Total Records</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="verified-records">8</div>
                <div class="stat-label">Verified Records</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="blockchain-records">3</div>
                <div class="stat-label">On Blockchain</div>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="dashboard">
            <!-- Genealogy Records -->
            <div class="card">
                <h2>üå≥ Family Tree Records</h2>
                <p>Click on any family member to view detailed genealogy information and submit to blockchain.</p>
                <button class="btn btn-primary" onclick="addSampleData()">Load Sample Data</button>
                <button class="btn btn-secondary" onclick="testMerkleTree()">Test Merkle Tree</button>
                <button class="btn" onclick="connectFamilySearch()">Connect FamilySearch</button>
            </div>

            <!-- Blockchain Operations -->
            <div class="card">
                <h2>‚õìÔ∏è Blockchain Operations</h2>
                <p>Manage blockchain connections and verify genealogy records using Merkle trees.</p>
                <button class="btn btn-primary" onclick="connectMetaMask()">Connect MetaMask</button>
                <button class="btn btn-secondary" onclick="deployContract()">Deploy Contract</button>
                <button class="btn" onclick="verifyMerkleProof()">Verify Records</button>
            </div>
        </div>

        <!-- Genealogy Grid -->
        <div id="genealogy-grid" class="genealogy-grid">
            <div class="person-card" onclick="showWelcomeMessage()">
                <div class="person-name">üëã Welcome!</div>
                <div class="person-info">
                    Click "Load Sample Data" to see family tree records, or connect to FamilySearch to import your genealogy data.
                </div>
            </div>
        </div>
    </div>

    <!-- Popup -->
    <div id="popupOverlay" class="popup-overlay" onclick="closePopup()">
        <div class="popup" onclick="event.stopPropagation()">
            <button class="close-btn" onclick="closePopup()">&times;</button>
            <div id="popupContent" class="popup-content">
                <!-- Content will be dynamically populated -->
            </div>
        </div>
    </div>

    <script>
        // Sample genealogy data
        const sampleFamilyData = [
            {
                name: "Marcus Johnson",
                data: {
                    birthDate: "March 15, 1985",
                    birthPlace: "Atlanta, Georgia",
                    currentResidence: "Washington, D.C.",
                    occupation: "Software Engineer",
                    parents: {
                        father: "James Johnson Sr.",
                        mother: "Dorothy Williams Johnson"
                    },
                    spouse: "Angela Marie Johnson",
                    children: "Marcus Jr. (8), Zoe (5)",
                    siblings: ["James Johnson Jr.", "Patricia Johnson-Smith"],
                    grandparents: {
                        paternal: {
                            grandfather: "Robert Johnson",
                            grandmother: "Mary Elizabeth Johnson"
                        },
                        maternal: {
                            grandfather: "William Williams",
                            grandmother: "Rosa Williams"
                        }
                    },
                    notes: "Family traced back to enslaved ancestors in South Carolina. Robert Johnson documented as enslaved on Magnolia Plantation from 1850-1865. Seeking reparations documentation for descendants."
                }
            },
            {
                name: "Dorothy Williams Johnson",
                data: {
                    birthDate: "June 22, 1960",
                    birthPlace: "Charleston, South Carolina",
                    currentResidence: "Atlanta, Georgia",
                    occupation: "Retired Teacher",
                    parents: {
                        father: "William Williams",
                        mother: "Rosa Mae Williams"
                    },
                    spouse: "James Johnson Sr.",
                    children: "Marcus, James Jr., Patricia",
                    siblings: ["Thomas Williams", "Sarah Williams-Davis"],
                    grandparents: {
                        paternal: {
                            grandfather: "Samuel Williams",
                            grandmother: "Bessie Williams"
                        },
                        maternal: {
                            grandfather: "John Thompson",
                            grandmother: "Clara Thompson"
                        }
                    },
                    notes: "Williams family documented on rice plantations in Charleston area. Samuel Williams listed in 1870 census as formerly enslaved. Strong oral history tradition maintained."
                }
            },
            {
                name: "James Johnson Sr.",
                data: {
                    birthDate: "August 10, 1958",
                    birthPlace: "Augusta, Georgia",
                    currentResidence: "Atlanta, Georgia",
                    occupation: "Construction Foreman",
                    parents: {
                        father: "Robert Johnson",
                        mother: "Mary Elizabeth Johnson"
                    },
                    spouse: "Dorothy Williams Johnson",
                    children: "Marcus, James Jr., Patricia",
                    siblings: ["Robert Johnson Jr.", "Helen Johnson-Brown"],
                    grandparents: {
                        paternal: {
                            grandfather: "Moses Johnson",
                            grandmother: "Ruth Johnson"
                        },
                        maternal: {
                            grandfather: "Charles Davis",
                            grandmother: "Emma Davis"
                        }
                    },
                    notes: "Johnson lineage traced to tobacco farms in Virginia. Moses Johnson documented in slave schedules, later sharecropper. Military service in segregated units documented."
                }
            }
        ];

        // Blockchain Integration Class
        class ReparationsBlockchain {
            constructor() {
                this.web3 = null;
                this.contract = null;
                this.account = null;
                this.contractAddress = null;
                this.contractABI = [];
            }

            async init() {
                if (typeof window.ethereum !== 'undefined') {
                    this.web3 = new Web3(window.ethereum);
                    try {
                        await window.ethereum.request({ method: 'eth_requestAccounts' });
                        const accounts = await this.web3.eth.getAccounts();
                        this.account = accounts[0];
                        
                        console.log('Connected to account:', this.account);
                        this.updateUI();
                        return true;
                    } catch (error) {
                        console.error('User denied account access');
                        return false;
                    }
                } else {
                    console.log('MetaMask not detected');
                    this.showMetaMaskWarning();
                    return false;
                }
            }

            updateUI() {
                const statusElement = document.getElementById('blockchain-status');
                if (statusElement) {
                    statusElement.innerHTML = `
                        <div class="blockchain-connected">
                            <p>‚úÖ Connected to blockchain</p>
                            <p>Account: ${this.account.substring(0, 6)}...${this.account.substring(38)}</p>
                        </div>
                    `;
                }
            }

            showMetaMaskWarning() {
                const statusElement = document.getElementById('blockchain-status');
                if (statusElement) {
                    statusElement.innerHTML = `
                        <div class="blockchain-warning">
                            <p>‚ö†Ô∏è MetaMask not detected</p>
                            <p>Please install MetaMask to use blockchain features</p>
                            <a href="https://metamask.io" target="_blank">Install MetaMask</a>
                        </div>
                    `;
                }
            }
        }

        // Merkle Tree Functions
        function hash(data) {
            return sha3_256(data);
        }

        function buildMerkleTree(leaves) {
            if (leaves.length === 1) return leaves;
            const newLevel = [];
            for (let i = 0; i < leaves.length; i += 2) {
                if (i + 1 < leaves.length) {
                    const combined = [leaves[i], leaves[i + 1]].sort().join("");
                    newLevel.push(hash(combined));
                } else {
                    newLevel.push(leaves[i]);
                }
            }
            return buildMerkleTree(newLevel);
        }

        function getProof(leaves, target) {
            const proof = [];
            let idx = leaves.indexOf(target);
            let level = leaves.slice();

            while (level.length > 1) {
                const newLevel = [];
                for (let i = 0; i < level.length; i += 2) {
                    let left = level[i];
                    let right = (i + 1 < level.length) ? level[i+1] : null;

                    if (i === idx || i+1 === idx) {
                        const sibling = (i === idx) ? right : left;
                        if (sibling) proof.push(sibling);
                        idx = Math.floor(i / 2);
                    }

                    if (right) {
                        const combined = [left, right].sort().join("");
                        newLevel.push(hash(combined));
                    } else {
                        newLevel.push(left);
                    }
                }
                level = newLevel;
            }
            return proof;
        }

        // Global variables
        let reparationsBlockchain;
        let currentFamilyData = [];

        // Initialize app
        document.addEventListener('DOMContentLoaded', async () => {
            reparationsBlockchain = new ReparationsBlockchain();
            await reparationsBlockchain.init();
            
            // Show initial message
            showWelcomeMessage();
        });

        // UI Functions
        function addSampleData() {
            currentFamilyData = sampleFamilyData;
            displayFamilyData();
            updateStats();
        }

        function displayFamilyData() {
            const grid = document.getElementById('genealogy-grid');
            grid.innerHTML = '';

            currentFamilyData.forEach((person, index) => {
                const card = document.createElement('div');
                card.className = 'person-card';
                card.onclick = () => showGenealogyPopup(person);
                
                card.innerHTML = `
                    <div class="person-name">${person.name}</div>
                    <div class="person-info">
                        Born: ${person.data.birthDate}<br>
                        Location: ${person.data.currentResidence}<br>
                        Occupation: ${person.data.occupation}
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        function showWelcomeMessage() {
            const popup = document.getElementById('popupOverlay');
            const content = document.getElementById('popupContent');
            
            content.innerHTML = `
                <h2 class="popup-title">üåü Welcome to Historical Accountability Database</h2>
                
                <div class="genealogy-section">
                    <h3 class="section-title">Getting Started</h3>
                    <p style="line-height: 1.6; color: #555;">
                        This application helps descendants of slave-owning families document historical connections 
                        and create verifiable blockchain records for accountability and historical preservation.
                    </p>
                    <ol style="margin: 15px 0; padding-left: 20px; color: #555; line-height: 1.8;">
                        <li><strong>Load Historical Data:</strong> Click "Load Sample Data" to see documented Hopewell family records from Maryland (1787-1850s)</li>
                        <li><strong>Connect MetaMask:</strong> Install and connect MetaMask wallet for blockchain functionality</li>
                        <li><strong>View Records:</strong> Click on family member cards to see detailed genealogy and slavery documentation</li>
                        <li><strong>Submit to Blockchain:</strong> Create immutable historical records with cryptographic verification</li>
                        <li><strong>Connect FamilySearch:</strong> Import additional genealogy data from FamilySearch API</li>
                    </ol>
                </div>

                <div class="genealogy-section merkle-section">
                    <h3 class="section-title">üîê Blockchain Verification</h3>
                    <p style="color: #2d5f3f; line-height: 1.6;">
                        This system uses Merkle trees and blockchain technology to create tamper-proof records 
                        documenting historical slavery connections in American family histories, initiated by 
                        descendants taking accountability for their ancestors' actions.
                    </p>
                </div>

                <div class="genealogy-section" style="background: #fff3cd; border-left: 4px solid #ffc107;">
                    <h3 class="section-title">üìö Historical Context</h3>
                    <p style="color: #856404; line-height: 1.6;">
                        The sample data includes real Maryland families (Hopewells, Chews, Biscoes) documented 
                        in wills, court records, and baptismal records from St. Mary's, Calvert, and Prince George's 
                        counties. Names of enslaved individuals are preserved from historical documents as acts 
                        of remembrance and accountability.
                    </p>
                </div>
            `;
            
            popup.classList.add('active');
        }

        function showGenealogyPopup(person) {
            const popup = document.getElementById('popupOverlay');
            const content = document.getElementById('popupContent');
            
            const data = person.data;
            
            content.innerHTML = `
                <h2 class="popup-title">${person.name}</h2>
                
                <div class="genealogy-section">
                    <h3 class="section-title">üìã Personal Information</h3>
                    <div class="info-grid">
                        <div class="info-label">Birth Date:</div>
                        <div class="info-value">${data.birthDate}</div>
                        <div class="info-label">Birth Place:</div>
                        <div class="info-value">${data.birthPlace}</div>
                        <div class="info-label">Current Residence:</div>
                        <div class="info-value">${data.currentResidence}</div>
                        <div class="info-label">Occupation:</div>
                        <div class="info-value">${data.occupation}</div>
                    </div>
                </div>
                
                <div class="genealogy-section">
                    <h3 class="section-title">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Information</h3>
                    <div class="info-grid">
                        <div class="info-label">Father:</div>
                        <div class="info-value">${data.parents.father}</div>
                        <div class="info-label">Mother:</div>
                        <div class="info-value">${data.parents.mother}</div>
                        <div class="info-label">Spouse:</div>
                        <div class="info-value">${data.spouse}</div>
                        <div class="info-label">Children:</div>
                        <div class="info-value">${data.children}</div>
                        <div class="info-label">Siblings:</div>
                        <div class="info-value">${data.siblings.join(', ')}</div>
                    </div>
                </div>
                
                <div class="genealogy-section">
                    <h3 class="section-title">üë¥üëµ Grandparents</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h4 style="color: #2980b9; margin-bottom: 10px;">Paternal</h4>
                            <div class="info-grid">
                                <div class="info-label">Grandfather:</div>
                                <div class="info-value">${data.grandparents.paternal.grandfather}</div>
                                <div class="info-label">Grandmother:</div>
                                <div class="info-value">${data.grandparents.paternal.grandmother}</div>
                            </div>
                        </div>
                        <div>
                            <h4 style="color: #2980b9; margin-bottom: 10px;">Maternal</h4>
                            <div class="info-grid">
                                <div class="info-label">Grandfather:</div>
                                <div class="info-value">${data.grandparents.maternal.grandfather}</div>
                                <div class="info-label">Grandmother:</div>
                                <div class="info-value">${data.grandparents.maternal.grandmother}</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="genealogy-section">
                    <h3 class="section-title">üìù Historical Notes</h3>
                    <p style="color: #555; line-height: 1.6; background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db;">${data.notes}</p>
                </div>
                
                <div class="genealogy-section merkle-section">
                    <h3 class="section-title">‚õìÔ∏è Blockchain Actions</h3>
                    <p style="color: #2d5f3f; margin-bottom: 15px;">Create an immutable record on the blockchain with Merkle proof verification.</p>
                    <button class="blockchain-submit-btn" onclick="submitToBlockchain('${person.name}')">
                        üîê Submit to Blockchain
                    </button>
                    <button class="blockchain-submit-btn" onclick="generateMerkleProof('${person.name}')" style="background: linear-gradient(45deg, #27ae60, #2ecc71); margin-left: 10px;">
                        üå≥ Generate Merkle Proof
                    </button>
                </div>
            `;
            
            popup.classList.add('active');
        }

        function closePopup() {
            document.getElementById('popupOverlay').classList.remove('active');
        }

        async function connectMetaMask() {
            if (reparationsBlockchain) {
                const connected = await reparationsBlockchain.init();
                if (connected) {
                    alert('‚úÖ Successfully connected to MetaMask!');
                } else {
                    alert('‚ùå Failed to connect to MetaMask. Please try again.');
                }
            }
        }

        function connectFamilySearch() {
            showFamilySearchSetup();
        }

        function showFamilySearchSetup() {
            const popup = document.getElementById('popupOverlay');
            const content = document.getElementById('popupContent');
            
            content.innerHTML = `
                <h2 class="popup-title">üå≥ Connect to FamilySearch</h2>
                
                <div class="genealogy-section">
                    <h3 class="section-title">üìã Setup Instructions</h3>
                    <ol style="line-height: 1.8; color: #555; padding-left: 20px;">
                        <li><strong>Get Developer Access:</strong>
                            <br>‚Ä¢ Go to <a href="https://www.familysearch.org/developers/" target="_blank" style="color: #3498db;">FamilySearch Developers</a>
                            <br>‚Ä¢ Sign in with your FamilySearch account
                            <br>‚Ä¢ Register a new app with callback URL: <code style="background: #f0f0f0; padding: 2px 6px;">${window.location.origin}/callback</code>
                        </li>
                        <li><strong>Get Your App ID:</strong>
                            <br>‚Ä¢ Copy your Client ID from the developer console
                            <br>‚Ä¢ Paste it in the field below
                        </li>
                        <li><strong>Authorize Access:</strong>
                            <br>‚Ä¢ Click "Connect" to authorize genealogy data access
                        </li>
                    </ol>
                </div>

                <div class="genealogy-section">
                    <h3 class="section-title">üîë API Configuration</h3>
                    <div style="margin: 15px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">FamilySearch App ID:</label>
                        <input type="text" id="familysearch-app-id" placeholder="Enter your FamilySearch App ID" 
                               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace;">
                    </div>
                    <button class="blockchain-submit-btn" onclick="initializeFamilySearchAuth()" style="background: linear-gradient(45deg, #27ae60, #2ecc71);">
                        üîó Connect to FamilySearch
                    </button>
                </div>

                <div class="genealogy-section merkle-section">
                    <h3 class="section-title">üß™ Test Without FamilySearch</h3>
                    <p style="color: #2d5f3f; margin-bottom: 15px;">
                        Don't have FamilySearch access yet? You can still test all features with sample data.
                    </p>
                    <button class="blockchain-submit-btn" onclick="loadExtendedSampleData()" style="background: linear-gradient(45deg, #f39c12, #e67e22);">
                        üìä Load Extended Sample Data
                    </button>
                </div>

                <div class="genealogy-section" style="background: #fff3cd; border-left: 4px solid #ffc107;">
                    <h3 class="section-title">‚ö†Ô∏è Privacy & Security</h3>
                    <p style="color: #856404; line-height: 1.6;">
                        <strong>Important:</strong> This integration will access your FamilySearch family tree data. 
                        Only connect if you understand and consent to this access. All data will be processed 
                        securely and can be used for blockchain verification.
                    </p>
                </div>
            `;
            
            popup.classList.add('active');
        }

        function initializeFamilySearchAuth() {
            const appIdInput = document.getElementById('familysearch-app-id');
            const appId = appIdInput.value.trim();
            
            if (!appId) {
                alert('‚ö†Ô∏è Please enter your FamilySearch App ID');
                return;
            }
            
            // Update configuration
            FAMILYSEARCH_CONFIG.clientId = appId;
            
            // Start OAuth flow
            authenticateWithFamilySearch();
        }

        function authenticateWithFamilySearch() {
            // Build OAuth URL
            const authParams = new URLSearchParams({
                response_type: 'code',
                client_id: FAMILYSEARCH_CONFIG.clientId,
                redirect_uri: FAMILYSEARCH_CONFIG.redirectUri,
                scope: 'openid profile email tree'
            });
            
            const authUrl = `${FAMILYSEARCH_CONFIG.authUrl}?${authParams.toString()}`;
            
            // Store auth state
            sessionStorage.setItem('familysearch_auth_state', 'pending');
            
            // Open authentication popup
            const authWindow = window.open(
                authUrl,
                'familysearch_auth',
                'width=500,height=600,scrollbars=yes,resizable=yes'
            );
            
            // Monitor for completion
            const checkClosed = setInterval(() => {
                if (authWindow.closed) {
                    clearInterval(checkClosed);
                    handleAuthComplete();
                }
            }, 1000);
        }

        async function handleAuthComplete() {
            const authCode = sessionStorage.getItem('familysearch_auth_code');
            
            if (authCode) {
                try {
                    // Exchange code for access token
                    const tokenResponse = await exchangeCodeForToken(authCode);
                    familySearchAuth = tokenResponse;
                    
                    // Fetch family tree data
                    await fetchFamilyTreeData();
                    
                    alert('‚úÖ Successfully connected to FamilySearch!\nFamily tree data loaded.');
                    closePopup();
                    
                } catch (error) {
                    console.error('FamilySearch authentication error:', error);
                    alert('‚ùå Authentication failed: ' + error.message);
                }
            } else {
                alert('‚ö†Ô∏è Authentication was cancelled or failed');
            }
        }

        async function exchangeCodeForToken(code) {
            // This would normally be done on your backend for security
            // For demo purposes, we'll simulate the token exchange
            
            console.log('Exchanging auth code for token...');
            
            // Simulated token response
            return {
                access_token: 'simulated_access_token_' + Date.now(),
                token_type: 'Bearer',
                expires_in: 3600
            };
        }

        async function fetchFamilyTreeData() {
            if (!familySearchAuth) {
                throw new Error('Not authenticated with FamilySearch');
            }
            
            try {
                // Simulate API calls - in real implementation, these would be actual API requests
                console.log('Fetching family tree data from FamilySearch...');
                
                // Simulated family tree data that would come from FamilySearch API
                const familySearchData = await simulateFamilySearchAPI();
                
                // Convert FamilySearch format to our format
                currentFamilyData = convertFamilySearchData(familySearchData);
                
                // Display the data
                displayFamilyData();
                updateStats();
                
            } catch (error) {
                console.error('Error fetching family tree data:', error);
                throw error;
            }
        }

        async function simulateFamilySearchAPI() {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Simulated FamilySearch API response format
            return {
                persons: [
                    {
                        id: "KWJY-123",
                        display: {
                            name: "Sarah Elizabeth Wilson",
                            birthDate: "15 April 1945",
                            birthPlace: "Birmingham, Alabama, United States",
                            deathDate: null
                        },
                        relationships: {
                            parents: ["KWJY-456", "KWJY-789"],
                            spouses: ["KWJY-234"],
                            children: ["KWJY-567", "KWJY-890"]
                        }
                    },
                    {
                        id: "KWJY-456",
                        display: {
                            name: "James Robert Wilson",
                            birthDate: "22 August 1920",
                            birthPlace: "Montgomery, Alabama, United States",
                            deathDate: "3 March 1995"
                        }
                    },
                    {
                        id: "KWJY-789",
                        display: {
                            name: "Mary Catherine Davis",
                            birthDate: "10 December 1922",
                            birthPlace: "Selma, Alabama, United States", 
                            deathDate: "18 June 2001"
                        }
                    }
                ]
            };
        }

        function convertFamilySearchData(fsData) {
            // Convert FamilySearch format to our internal format
            return fsData.persons.map(person => ({
                name: person.display.name,
                data: {
                    birthDate: person.display.birthDate || "Unknown",
                    birthPlace: person.display.birthPlace || "Unknown",
                    currentResidence: "Information from FamilySearch",
                    occupation: "Researching...",
                    parents: {
                        father: "From FamilySearch API",
                        mother: "From FamilySearch API"
                    },
                    spouse: "From FamilySearch API",
                    children: "From FamilySearch API", 
                    siblings: ["From FamilySearch API"],
                    grandparents: {
                        paternal: {
                            grandfather: "Available in FamilySearch",
                            grandmother: "Available in FamilySearch"
                        },
                        maternal: {
                            grandfather: "Available in FamilySearch", 
                            grandmother: "Available in FamilySearch"
                        }
                    },
                    notes: `Imported from FamilySearch on ${new Date().toLocaleDateString()}. ID: ${person.id}. Additional research needed for reparations documentation.`
                }
            }));
        }

        function loadExtendedSampleData() {
            // Load more comprehensive sample data for testing
            const extendedData = [
                ...sampleFamilyData,
                {
                    name: "Rosa Mae Williams",
                    data: {
                        birthDate: "September 8, 1935",
                        birthPlace: "Beaufort, South Carolina",
                        currentResidence: "Charleston, South Carolina",
                        occupation: "Retired Seamstress",
                        parents: {
                            father: "Samuel Williams",
                            mother: "Bessie Thompson Williams"
                        },
                        spouse: "William Williams (deceased)",
                        children: "Dorothy, Thomas, Sarah",
                        siblings: ["John Thompson Williams", "Clara Williams-Johnson"],
                        grandparents: {
                            paternal: {
                                grandfather: "Joshua Williams (enslaved)",
                                grandmother: "Hannah Williams (enslaved)"
                            },
                            maternal: {
                                grandfather: "Isaac Thompson (enslaved)",
                                grandmother: "Ruth Thompson (enslaved)"
                            }
                        },
                        notes: "Strong documentation of enslaved ancestors on Magnolia and Boone Hall plantations. Joshua Williams recorded in 1860 slave schedule. Family oral history includes stories of freedom and Reconstruction era struggles."
                    }
                },
                {
                    name: "Samuel Williams",
                    data: {
                        birthDate: "March 12, 1910",
                        birthPlace: "Johns Island, South Carolina", 
                        currentResidence: "Charleston, South Carolina (deceased 1978)",
                        occupation: "Farmer, later Construction Worker",
                        parents: {
                            father: "Joshua Williams",
                            mother: "Hannah Williams"
                        },
                        spouse: "Bessie Thompson Williams",
                        children: "Rosa Mae, John Thompson, Clara",
                        siblings: ["Moses Williams", "Ruth Williams-Davis"],
                        grandparents: {
                            paternal: {
                                grandfather: "Unknown (enslaved)",
                                grandmother: "Unknown (enslaved)"
                            },
                            maternal: {
                                grandfather: "Unknown (enslaved)",
                                grandmother: "Unknown (enslaved)"
                            }
                        },
                        notes: "Born to formerly enslaved parents. Joshua Williams documented as field hand on Magnolia Plantation. Samuel worked as sharecropper before moving to Charleston during Great Migration. Military service in segregated unit during WWII."
                    }
                }
            ];

            currentFamilyData = extendedData;
            displayFamilyData();
            updateStats();
            closePopup();
            alert('üìä Extended sample data loaded!\n\n‚Ä¢ 5 family members with detailed records\n‚Ä¢ Historical documentation links\n‚Ä¢ Enslaved ancestor references\n‚Ä¢ Ready for blockchain submission');
        }

        function deployContract() {
            alert('üìú Smart contract deployment requires:\n\n‚Ä¢ Connected MetaMask wallet\n‚Ä¢ Test network (like Goerli)\n‚Ä¢ ETH for gas fees\n\nContract will be deployed using Truffle framework.');
        }

        function testMerkleTree() {
            if (currentFamilyData.length === 0) {
                alert('‚ö†Ô∏è Please load sample data first!');
                return;
            }

            // Create sample entries for Merkle tree
            const entries = currentFamilyData.map(person => 
                `${person.name}: ${JSON.stringify(person.data)}`
            );
            
            // Generate hashes
            const leaves = entries.map(entry => hash(entry));
            const root = buildMerkleTree(leaves)[0];
            
            // Generate proof for first entry
            const proof = getProof(leaves, leaves[0]);
            
            alert(`üå≥ Merkle Tree Generated!\n\nRoot: ${root.substring(0, 16)}...\nProof elements: ${proof.length}\nFirst person: ${currentFamilyData[0].name}\n\nThis cryptographic proof can verify record integrity on blockchain.`);
        }

        async function submitToBlockchain(personName) {
            if (!reparationsBlockchain || !reparationsBlockchain.account) {
                alert('‚ö†Ô∏è Please connect MetaMask first!');
                return;
            }
            
            // Find the person data
            const person = currentFamilyData.find(p => p.name === personName);
            if (!person) {
                alert('‚ùå Person data not found');
                return;
            }

            try {
                // Create a hash of the genealogy data
                const genealogyData = JSON.stringify(person.data);
                const dataHash = hash(genealogyData);
                
                // For demo - simulate blockchain submission
                const simulatedTxHash = '0x' + Math.random().toString(16).substr(2, 40);
                
                alert(`‚úÖ Successfully submitted to blockchain!\n\nPerson: ${personName}\nData Hash: ${dataHash.substring(0, 16)}...\nTransaction: ${simulatedTxHash}\n\n(This is a simulation - real implementation would require deployed contract)`);
                
                // Update stats
                document.getElementById('blockchain-records').textContent = 
                    parseInt(document.getElementById('blockchain-records').textContent) + 1;
                    
            } catch (error) {
                console.error('Error submitting to blockchain:', error);
                alert('‚ùå Error submitting to blockchain: ' + error.message);
            }
        }

        function generateMerkleProof(personName) {
            if (currentFamilyData.length === 0) {
                alert('‚ö†Ô∏è Please load sample data first!');
                return;
            }

            // Find the person
            const person = currentFamilyData.find(p => p.name === personName);
            if (!person) {
                alert('‚ùå Person not found');
                return;
            }

            // Create entries for Merkle tree
            const entries = currentFamilyData.map(p => 
                `${p.name}: ${JSON.stringify(p.data)}`
            );
            
            // Generate hashes
            const leaves = entries.map(entry => hash(entry));
            const targetLeaf = hash(`${person.name}: ${JSON.stringify(person.data)}`);
            
            // Build tree and get proof
            const root = buildMerkleTree(leaves)[0];
            const proof = getProof(leaves, targetLeaf);
            
            // Display proof information
            const proofInfo = `
üå≥ Merkle Proof Generated for ${personName}

üîê Root Hash: ${root.substring(0, 20)}...
üìä Proof Length: ${proof.length} elements
üéØ Target Leaf: ${targetLeaf.substring(0, 20)}...

Proof Elements:
${proof.map((p, i) => `${i + 1}. ${p.substring(0, 20)}...`).join('\n')}

This proof can cryptographically verify that ${personName}'s record is included in the Merkle tree without revealing other family members' data.
            `;
            
            alert(proofInfo);
        }

        function verifyMerkleProof() {
            if (currentFamilyData.length === 0) {
                alert('‚ö†Ô∏è Please load sample data first!');
                return;
            }

            // Simulate verification
            const entries = currentFamilyData.map(p => 
                `${p.name}: ${JSON.stringify(p.data)}`
            );
            const leaves = entries.map(entry => hash(entry));
            const root = buildMerkleTree(leaves)[0];
            const firstPersonLeaf = leaves[0];
            const proof = getProof(leaves, firstPersonLeaf);

            // Verify the proof
            let computedHash = firstPersonLeaf;
            for (let i = 0; i < proof.length; i++) {
                const proofElement = proof[i];
                if (computedHash <= proofElement) {
                    computedHash = hash(computedHash + proofElement);
                } else {
                    computedHash = hash(proofElement + computedHash);
                }
            }

            const isValid = computedHash === root;
            
            alert(`üîç Merkle Proof Verification\n\nResult: ${isValid ? '‚úÖ VALID' : '‚ùå INVALID'}\nComputed Root: ${computedHash.substring(0, 20)}...\nExpected Root: ${root.substring(0, 20)}...\n\nThis demonstrates cryptographic verification of genealogy records.`);
        }

        function updateStats() {
            document.getElementById('total-records').textContent = currentFamilyData.length;
            document.getElementById('verified-records').textContent = Math.floor(currentFamilyData.length * 0.8);
        }

        // Handle popup clicks
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('popup-overlay')) {
                closePopup();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closePopup();
            }
        });
    </script>
</body>
</html>
