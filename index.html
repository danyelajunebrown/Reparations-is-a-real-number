<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reparations Descendant Visualization</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.9.2/dist/sha3.min.js"></script>
  <script src="reparations-calculator.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
      color: #fff;
      font-family: 'Arial', sans-serif;
      overflow: hidden;
      position: relative;
    }

    /* Animated background particles */
    .particles {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      z-index: 1;
    }

    .particle {
      position: absolute;
      width: 2px;
      height: 2px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      animation: float 6s infinite linear;
    }

    @keyframes float {
      0% { transform: translateY(100vh) translateX(0); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(-100px) translateX(50px); opacity: 0; }
    }

    #stick-figures {
      position: absolute;
      bottom: 20px;
      width: 100%;
      display: flex;
      justify-content: space-around;
      align-items: flex-end;
      height: 200px;
      pointer-events: none;
      z-index: 10;
    }

    .stick {
      width: 20px;
      height: 80px;
      position: relative;
      pointer-events: auto;
      cursor: pointer;
      animation: walk 2s infinite linear;
      transition: all 0.3s ease;
    }

    .stick:hover {
      transform: scale(1.1);
    }

    .stick::before {
      content: '';
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(45deg, #fff, #e0e0e0);
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    }

    .stick::after {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 2px;
      height: 80px;
      background: linear-gradient(to bottom, #fff, #ccc);
      box-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
    }

    @keyframes walk {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .stick.paused {
      animation-play-state: paused;
      background: none;
    }

    #info-panel {
      position: absolute;
      top: 5%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15, 15, 30, 0.95);
      border: 2px solid #4a90e2;
      border-radius: 15px;
      padding: 25px;
      max-width: 800px;
      max-height: 85vh;
      overflow-y: auto;
      display: none;
      z-index: 1000;
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    }

    #info-panel h2 {
      margin-top: 0;
      font-size: 1.8em;
      border-bottom: 2px solid #4a90e2;
      padding-bottom: 10px;
      color: #4a90e2;
      text-align: center;
    }

    .close-btn {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 1.5em;
      cursor: pointer;
      color: #aaa;
      transition: color 0.3s;
    }
    
    .close-btn:hover { 
      color: #fff; 
      transform: scale(1.1);
    }

    .calculation-section {
      margin: 20px 0;
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      border-left: 4px solid #4a90e2;
    }

    .breakdown-item {
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
      padding: 5px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .total-amount {
      font-size: 1.3em;
      font-weight: bold;
      color: #4a90e2;
      background: rgba(74, 144, 226, 0.1);
      padding: 10px;
      border-radius: 8px;
      margin: 15px 0;
    }

    .blockchain-btn {
      background: linear-gradient(45deg, #4a90e2, #357abd);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1em;
      margin: 10px 5px;
      transition: all 0.3s ease;
    }

    .blockchain-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(74, 144, 226, 0.3);
    }

    .methodology-section {
      margin-top: 25px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 10px;
      font-size: 0.9em;
      line-height: 1.4;
    }

    /* Header with platform info */
    .platform-header {
      position: absolute;
      top: 20px;
      left: 20px;
      right: 20px;
      text-align: center;
      z-index: 5;
    }

    .platform-title {
      font-size: 2.5em;
      font-weight: bold;
      margin: 0;
      background: linear-gradient(45deg, #4a90e2, #fff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 30px rgba(74, 144, 226, 0.5);
    }

    .platform-subtitle {
      font-size: 1.2em;
      margin: 5px 0;
      opacity: 0.8;
    }

    /* Loading animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4a90e2;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Animated background particles -->
  <div class="particles" id="particles"></div>

  <!-- Platform Header -->
  <div class="platform-header">
    <h1 class="platform-title">Reparations Ledger</h1>
    <p class="platform-subtitle">Blockchain-Based Justice Platform</p>
  </div>

  <div id="stick-figures"></div>

  <div id="info-panel">
    <span class="close-btn" onclick="closePanel()">&times;</span>
    <div id="info-content"></div>
  </div>

  <script>
    // Initialize the modular calculator
    const reparationsCalc = new ReparationsCalculator({
      currentYear: 2024,
      baseYear: 1800,
      inflationRate: 0.035
    });

    // Create animated background particles
    function createParticles() {
      const particlesContainer = document.getElementById('particles');
      for (let i = 0; i < 50; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 6 + 's';
        particle.style.animationDuration = (Math.random() * 3 + 4) + 's';
        particlesContainer.appendChild(particle);
      }
    }

    // Enhanced ancestor data with historical context
    const ancestorData = [
      { name: "James Hopewell Sr.", enslavedCount: 28, years: 30, location: "Virginia", period: "1790-1820" },
      { name: "Ann Angelica Chesley Hopewell", enslavedCount: 8, years: 20, location: "South Carolina", period: "1800-1820" },
      { name: "Hugh Hopewell V", enslavedCount: 10, years: 25, location: "Georgia", period: "1810-1835" },
      { name: "Elizabeth Edmondson Hopewell", enslavedCount: 7, years: 20, location: "Virginia", period: "1820-1840" },
      { name: "Ann Maria Hopewell Biscoe", enslavedCount: 12, years: 25, location: "Maryland", period: "1825-1850" }
    ];

    // Current descendants
    let descendants = [
      { name: "Danyela June Brown", relationship: "Great-great-granddaughter" },
      { name: "Adrian Lee Brown", relationship: "Great-great-grandson" },
      { name: "Bailey Aboendqshane Smith", relationship: "Great-great-grandson" }
    ];

    // Compute comprehensive reparations using modular calculator
    function computeComprehensiveReparations() {
      try {
        const result = reparationsCalc.calculateMultipleAncestors(ancestorData, {
          includeInterest: true,
          includePenalty: true
        });
        
        const distribution = reparationsCalc.distributeReparations(
          result.totals.total, 
          descendants, 
          'equal'
        );

        return {
          ...result,
          distribution
        };
      } catch (error) {
        console.error('Error calculating reparations:', error);
        return null;
      }
    }

    function createStickFigures() {
      const container = document.getElementById("stick-figures");
      container.innerHTML = "";
      descendants.forEach((descendant, index) => {
        const div = document.createElement("div");
        div.className = "stick";
        div.style.animationDelay = (index * 0.3) + "s";
        div.addEventListener("mouseenter", () => showEnhancedInfo(descendant, div));
        div.addEventListener("click", () => showEnhancedInfo(descendant, div));
        container.appendChild(div);
      });
    }

    function showEnhancedInfo(descendant, stickElement) {
      // Pause all animations and highlight selected figure
      document.querySelectorAll(".stick").forEach(s => s.classList.remove("paused"));
      stickElement.classList.add("paused");

      const reparationsData = computeComprehensiveReparations();
      if (!reparationsData) {
        alert("Error calculating reparations. Please check the console.");
        return;
      }

      const descendantShare = reparationsData.distribution.distribution.find(d => d.name === descendant.name);
      
      // Generate detailed breakdown HTML
      let ancestorBreakdownHtml = reparationsData.breakdowns.map(breakdown => `
        <div class="calculation-section">
          <h4 style="color: #4a90e2; margin: 0 0 10px 0;">${breakdown.ancestor}</h4>
          <div class="breakdown-item">
            <span>Enslaved Individuals:</span>
            <span>${breakdown.metadata.enslavedCount}</span>
          </div>
          <div class="breakdown-item">
            <span>Years of Enslavement:</span>
            <span>${breakdown.metadata.years}</span>
          </div>
          <div class="breakdown-item">
            <span>Wage Theft:</span>
            <span>$${breakdown.wageTheft.toLocaleString()}</span>
          </div>
          <div class="breakdown-item">
            <span>Human Dignity Damages:</span>
            <span>$${breakdown.damages.toLocaleString()}</span>
          </div>
          <div class="breakdown-item">
            <span>Profit Share:</span>
            <span>$${breakdown.profitShare.toLocaleString()}</span>
          </div>
          <div class="breakdown-item">
            <span>Compound Interest:</span>
            <span>$${breakdown.compoundInterest.toLocaleString()}</span>
          </div>
          <div class="breakdown-item">
            <span>Delayed Justice Penalty:</span>
            <span>$${breakdown.penalty.toLocaleString()}</span>
          </div>
          <div class="total-amount">
            <div class="breakdown-item">
              <span><strong>Ancestor Total:</strong></span>
              <span><strong>$${breakdown.total.toLocaleString()}</strong></span>
            </div>
          </div>
        </div>
      `).join("");

      let distributionHtml = reparationsData.distribution.distribution.map(d => `
        <div class="breakdown-item">
          <span>${d.name}:</span>
          <span>$${d.share.toLocaleString()} (${d.percentage}%)</span>
        </div>
      `).join("");

      document.getElementById("info-content").innerHTML = `
        <h2>${descendant.name}</h2>
        
        <div class="calculation-section">
          <h3 style="color: #4a90e2;">💰 Total Reparations Owed</h3>
          <div class="total-amount">
            <div class="breakdown-item">
              <span><strong>Grand Total (All Ancestors):</strong></span>
              <span><strong>$${reparationsData.totals.total.toLocaleString()}</strong></span>
            </div>
          </div>
          
          <div class="breakdown-item">
            <span>Total Wage Theft:</span>
            <span>${reparationsData.totals.wageTheft.toLocaleString()}</span>
          </div>
          <div class="breakdown-item">
            <span>Total Damages:</span>
            <span>${reparationsData.totals.damages.toLocaleString()}</span>
          </div>
          <div class="breakdown-item">
            <span>Total Profit Share:</span>
            <span>${reparationsData.totals.profitShare.toLocaleString()}</span>
          </div>
          <div class="breakdown-item">
            <span>Total Compound Interest:</span>
            <span>${reparationsData.totals.compoundInterest.toLocaleString()}</span>
          </div>
          <div class="breakdown-item">
            <span>Total Penalties:</span>
            <span>${reparationsData.totals.penalty.toLocaleString()}</span>
          </div>
        </div>

        <div class="calculation-section">
          <h3 style="color: #4a90e2;">👥 Individual Share</h3>
          <div class="total-amount">
            <div class="breakdown-item">
              <span><strong>${descendant.name}'s Share:</strong></span>
              <span><strong>${descendantShare.share.toLocaleString()}</strong></span>
            </div>
          </div>
          <p style="opacity: 0.8; font-size: 0.9em;">
            Split equally among ${descendants.length} documented descendants
          </p>
        </div>

        <h3 style="color: #4a90e2; margin-top: 25px;">📊 Breakdown by Ancestor</h3>
        ${ancestorBreakdownHtml}
        
        <div class="calculation-section">
          <h3 style="color: #4a90e2;">📋 Distribution Summary</h3>
          ${distributionHtml}
        </div>

        <div class="methodology-section">
          <h4 style="color: #4a90e2; margin-top: 0;">📈 Calculation Methodology</h4>
          <p><strong>Inflation Rate:</strong> ${(reparationsCalc.inflationRate * 100).toFixed(1)}% annually from ${reparationsCalc.baseYear}</p>
          <p><strong>Compound Interest:</strong> ${(reparationsCalc.compoundInterestRate * 100).toFixed(1)}% annually on unpaid debt</p>
          <p><strong>Base Year:</strong> ${reparationsCalc.baseYear} (historical reference point)</p>
          <p><strong>Current Year:</strong> ${reparationsCalc.currentYear}</p>
          <p><strong>Calculation Date:</strong> ${new Date().toLocaleDateString()}</p>
          
          <h5 style="color: #4a90e2;">Components:</h5>
          <ul style="margin: 10px 0; padding-left: 20px; line-height: 1.6;">
            <li><strong>Wage Theft:</strong> Unpaid labor compensation adjusted for inflation</li>
            <li><strong>Human Dignity Damages:</strong> Compensation for violation of human rights</li>
            <li><strong>Profit Share:</strong> Fair share of profits generated from enslaved labor</li>
            <li><strong>Compound Interest:</strong> Interest on unpaid debt over ${reparationsData.totals.metadata?.years || (reparationsCalc.currentYear - reparationsCalc.baseYear)} years</li>
            <li><strong>Delayed Justice Penalty:</strong> Additional penalty for systematic delay in providing justice</li>
          </ul>
        </div>

        <div style="text-align: center; margin-top: 20px;">
          <button class="blockchain-btn" onclick="submitToBlockchain('${descendant.name}', ${descendantShare.share}, reparationsData)">
            🔗 Submit to Blockchain
          </button>
          <button class="blockchain-btn" onclick="generateDetailedReport(reparationsData, '${descendant.name}')">
            📄 Generate Report
          </button>
          <button class="blockchain-btn" onclick="exportCalculationData(reparationsData)">
            💾 Export Data
          </button>
        </div>
      `;
      
      document.getElementById("info-panel").style.display = "block";
    }

    function closePanel() {
      document.getElementById("info-panel").style.display = "none";
      document.querySelectorAll(".stick").forEach(s => s.classList.remove("paused"));
    }

    // Enhanced blockchain submission with comprehensive data
    async function submitToBlockchain(descendantName, share, reparationsData) {
      try {
        // Show loading state
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<span class="loading"></span> Submitting...';
        button.disabled = true;

        // Simulate blockchain transaction (replace with actual Web3 calls)
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Create comprehensive blockchain record
        const blockchainRecord = {
          descendant: descendantName,
          share: share,
          totalReparations: reparationsData.totals.total,
          ancestorCount: reparationsData.breakdowns.length,
          calculationDate: new Date().toISOString(),
          methodology: reparationsCalc.exportParameters(),
          ancestors: reparationsData.breakdowns.map(b => ({
            name: b.ancestor,
            total: b.total,
            metadata: b.metadata
          }))
        };

        console.log('Submitting to blockchain:', blockchainRecord);
        
        // Reset button
        button.innerHTML = originalText;
        button.disabled = false;
        
        alert(`✅ Successfully submitted to blockchain!\n\nDescendant: ${descendantName}\nShare: ${share.toLocaleString()}\n\nTransaction hash: 0x${Math.random().toString(16).substr(2, 64)}`);
        
      } catch (error) {
        console.error('Blockchain submission error:', error);
        alert('❌ Error submitting to blockchain: ' + error.message);
        
        // Reset button on error
        const button = event.target;
        button.innerHTML = '🔗 Submit to Blockchain';
        button.disabled = false;
      }
    }

    // Generate detailed report
    function generateDetailedReport(reparationsData, descendantName) {
      try {
        // Use the modular calculator's report generation
        const sampleCalculation = reparationsData.breakdowns[0]; // Use first ancestor as sample
        const report = reparationsCalc.generateReport(sampleCalculation);
        
        const fullReport = `
COMPREHENSIVE REPARATIONS REPORT
================================

Generated for: ${descendantName}
Generation Date: ${new Date().toLocaleDateString()}

SUMMARY:
--------
Total Reparations (All Ancestors): ${reparationsData.totals.total.toLocaleString()}
Individual Share: ${Math.round(reparationsData.totals.total / descendants.length).toLocaleString()}
Number of Ancestors: ${reparationsData.breakdowns.length}
Number of Descendants: ${descendants.length}

ANCESTOR BREAKDOWN:
-------------------
${reparationsData.breakdowns.map(b => `
${b.ancestor}:
- Enslaved Count: ${b.metadata.enslavedCount}
- Years: ${b.metadata.years} 
- Total Owed: ${b.total.toLocaleString()}
`).join('')}

${report}

DISTRIBUTION:
-------------
${reparationsData.distribution.distribution.map(d => 
  `${d.name}: ${d.share.toLocaleString()} (${d.percentage}%)`
).join('\n')}

This report is generated using documented historical data and established 
economic principles for calculating fair compensation.
        `;

        // Create downloadable report
        const blob = new Blob([fullReport], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `reparations-report-${descendantName.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert('📄 Report generated and downloaded!');
        
      } catch (error) {
        console.error('Report generation error:', error);
        alert('❌ Error generating report: ' + error.message);
      }
    }

    // Export calculation data as JSON
    function exportCalculationData(reparationsData) {
      try {
        const exportData = {
          ...reparationsData,
          calculationParameters: reparationsCalc.exportParameters(),
          exportDate: new Date().toISOString(),
          platform: 'Reparations Ledger v1.0'
        };

        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `reparations-data-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert('💾 Calculation data exported successfully!');
        
      } catch (error) {
        console.error('Data export error:', error);
        alert('❌ Error exporting data: ' + error.message);
      }
    }

    // Initialize the application
    function initializeApp() {
      createParticles();
      createStickFigures();
      
      // Display total reparations in console for debugging
      const totalReparations = computeComprehensiveReparations();
      if (totalReparations) {
        console.log('Total Reparations Calculated:', totalReparations.totals.total.toLocaleString());
        console.log('Calculation Details:', totalReparations);
      }
    }

    // Start the application
    initializeApp();

    // Add keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closePanel();
      }
    });

    // Click outside panel to close
    document.getElementById('info-panel').addEventListener('click', (e) => {
      if (e.target.id === 'info-panel') {
        closePanel();
      }
    });
  </script>
</body>
</html>
